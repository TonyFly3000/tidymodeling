---
title: "All page first time"
subtitle: "with whiskyfun.com data"
author: "Tony Duan"

execute:
  warning: false
  error: false
  eval: false
format:
  html:
    toc: true
    toc-location: right
    code-fold: show
    code-tools: true
    number-sections: true
    code-block-bg: true
    code-block-border-left: "#31BAE9"
---


```{r}
library(tidyverse)
library(rvest)
library(stringr)
library(openxlsx)
library(readxl)
library(lubridate)
library(ggplot2)
```

```{r}
packageVersion("rvest")
```


# input


```{r}
data001=read_excel('all_page_review_1001-2000.xlsx')
```

```{r}
glimpse(data001)
```


```{r}
'asdgarsg d552 points'%>% str_extract("[:digit:][:digit:][:space:]points")
```

```{r}
data002=data001%>% mutate(
  
  bottle_review2=bottle_review2%>% str_replace("–", "-")%>% str_replace("Palate:", "Mouth")
  ,name=paste0(str_extract(bottle_review2, regex( "[^)]+")),")")
  
  ,colour=(bottle_review2 %>% str_match("Colour\\s*(.*?)\\s*\\."))[,2]
  ,nose=(bottle_review2 %>% str_match("Nose:\\s*(.*?)\\s*Mouth"))[,2]
  ,mouth=(bottle_review2 %>% str_match("Mouth\\s*(.*?)\\s*Finish:"))[,2]
  ,finish=(bottle_review2 %>% str_match("Finish:\\s*(.*?)\\s*Comments:"))[,2]
  ,comments=(bottle_review2 %>% str_match("Comments:\\s*(.*?)\\s*SGP:"))[,2]
  
  #,full_score=(bottle_review2 %>%str_match_all("[:digit:][:digit:][:space:]points."))%>% sapply(tail, 1)
  ,full_score=(bottle_review2 %>%str_match_all("[:digit:][:digit:][:space:]points."))%>% sapply(tail, 1)
  ,score=full_score %>% str_replace("points.","") %>% as.numeric()
  
  ,review_date=((str_match(old_page %>%str_to_lower(),"https://www.whiskyfun.com/archive\\s*(.*?)\\s*-"))[,2] )%>% str_to_title()
  ,review_date2= myd(review_date, truncated = 1)
  ,review_year=year(review_date2)
)

glimpse(data002)
```


```{r}
write.xlsx(data002,'test.xlsx')
```

Port Ellen 12 yo (OB, The Queen’s Visit to Port Ellen’s Maltings, 1980) 

February 4, 2015
https://www.whiskyfun.com/archivefebruary15-1-Ardbeg-Laphroaig-Caol-Ila-Lagavulin-Bowmore-Bunnahabhain.html

SGP:657 - 99 points.



```{r}
("he short run): 99 points. SGP:920 - 49 points." %>%str_match_all("[:digit:][:digit:][:space:]points."))%>% sapply(tail, 1)
```




















```{r}
data002=data001 %>% mutate(
  page_link_count=str_count(old_page,'www.whiskyfun.com'))%>%mutate(
    page_link=ifelse(page_link_count==2,str_replace(old_page,"https://www.whiskyfun.com/",""),old_page))%>%mutate(
    after_page_link_count=str_count(page_link,'www.whiskyfun.com')) %>% mutate(
      review_date=((str_match(page_link,"https://www.whiskyfun.com/archive\\s*(.*?)\\s*-"))[,2] )%>% str_to_title()
      ,review_date2= myd(review_date, truncated = 1)
      ,review_year=year(review_date2)
      ,bottle_score=str_replace(bottle_score,'–','-')
      ,bottle_final_score= (bottle_score%>% str_match("-\\s*(.*?)\\s*points"))[,2]
        ,score=bottle_final_score %>% str_extract("(\\d)+")%>% as.numeric()           
              ,review_year_flag=ifelse(review_year>=2020,'>=2020','<2020')    
    ) %>% arrange(desc(score))
```




```{r}
data003=data002 %>%  filter(review_date2>='2010-01-01'
                            ,score<=98)
                            #,score>=70)
```


```{r}
glimpse(data003)
```





```{r}
library(scales)
test001a=data003 %>% filter(review_year>=2018) %>% group_by(score) %>% summarise(n=n()) %>% mutate(percent = (n/sum(n))) %>% arrange(desc(score)) %>% mutate(review_year_flag='>=2020')
```


```{r}
library(scales)
test001b=data003 %>% filter(review_year<2018) %>% group_by(score) %>% summarise(n=n()) %>% mutate(percent = (n/sum(n))) %>% arrange(desc(score)) %>% mutate(review_year_flag='<2020')
```


```{r}
test001c=rbind(test001a,test001b) %>% filter(score>=75)
```

```{r}
p=ggplot(test001c, aes(score,percent,color=review_year_flag)) + geom_point()+ geom_line()
p
```



```{r}
ggplot(data003, aes(score,fill=review_year_flag))+geom_histogram(position = 'dodge')
```

```{r}
ggplot(test001b, aes(x=score,y=percent))+ geom_bar(stat="identity")
```

```{r}
ggplot(data003, aes(score)) + 
  geom_histogram()
```

```{r}
p=ggplot(data003, aes(review_date2, score)) + geom_point()
p
```


```{r}
data004=data003 %>% mutate(above_90=ifelse(score>=90,1,0)) %>% group_by(review_year) %>% summarise(n=n()
                                            ,avg_score=mean(score)
                                            ,above_90=sum(above_90)
                                            )
```


```{r}
p=ggplot(data004, aes(review_year,above_90/n)) + geom_point()+ geom_line()
p
```



```{r}
p=ggplot(data004, aes(review_year,avg_score)) + geom_point()+ geom_line()
p
```

```{r}
p=ggplot(data004, aes(review_year,n)) + geom_point()+ geom_line()
p
```


```{r}
p=ggplot(data003, aes(review_year,score,color=as.character(review_year)))  + geom_boxplot()
p
```



# ouput

```{r}
write.xlsx(data003,'all_page_review_after_clean.xlsx')
```


# reference
%d = Day number of month (5, 17, 28, etc.)
%j = Day number of the year (Julian day 001-366)
%a = Abbreviated weekday (Mon, Tue, Wed, etc.)
%A = Full weekday (Monday, Tuesday, etc.) %w = Weekday number (0-6, Sunday is 0)
%u = Weekday number (1-7, Monday is 1)
%W = Week number (00-53, Monday is week start)
%U = Week number (01-53, Sunday is week start)
%m = Month number (e.g. 01, 02, 03, 04)
%b = Abbreviated month (Jan, Feb, etc.)
%B = Full month (January, February, etc.)
%y = 2-digit year (e.g. 89)
%Y = 4-digit year (e.g. 1989)
%h = hours (24-hr clock)
%m = minutes
%s = seconds %z = offset from GMT
%Z = Time zone (character)


https://epirhandbook.com/en/working-with-dates.html
