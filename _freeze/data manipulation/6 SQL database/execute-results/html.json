{
  "hash": "985ec6e1f30c7e58ff78569a8441e923",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"SQL database with R\"\nauthor: \"Tony Duan\"\n\nexecute:\n  warning: false\n  error: false\nformat:\n  html:\n    toc: true\n    toc-location: right\n    code-fold: show\n    code-tools: true\n    number-sections: true\n    code-block-bg: true\n    code-block-border-left: \"#31BAE9\"\n---\n\n![](images/1594917913096.png){width=\"600\"}\n\n# Connection with database\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(DBI)\nlibrary(RSQLite)\nlibrary(connections)\n```\n:::\n\n\n## create database file pythonsqlite.db and copy mtcars data and iris data into database\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmtcars=cbind(newColName = rownames(mtcars), mtcars)\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Create an ephemeral in-memory RSQLite database\ncon <- dbConnect(RSQLite::SQLite(), \"my_sql_database\")\n\n# view database on IDE\nconnection_view(con)\n```\n:::\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndbWriteTable(con, \"mtcars\", mtcars,overwrite=TRUE)\ndbWriteTable(con, \"iris\", iris,overwrite=TRUE)\n```\n:::\n\n## check all table in database\n\n::: {.cell}\n\n```{.r .cell-code}\ndbListTables(con)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"iris\"   \"mtcars\"\n```\n\n\n:::\n:::\n\n# SQL\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata=dbReadTable(con, \"mtcars\")\nhead(data)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n         newColName  mpg cyl disp  hp drat    wt  qsec vs am gear carb\n1         Mazda RX4 21.0   6  160 110 3.90 2.620 16.46  0  1    4    4\n2     Mazda RX4 Wag 21.0   6  160 110 3.90 2.875 17.02  0  1    4    4\n3        Datsun 710 22.8   4  108  93 3.85 2.320 18.61  1  1    4    1\n4    Hornet 4 Drive 21.4   6  258 110 3.08 3.215 19.44  1  0    3    1\n5 Hornet Sportabout 18.7   8  360 175 3.15 3.440 17.02  0  0    3    2\n6           Valiant 18.1   6  225 105 2.76 3.460 20.22  1  0    3    1\n```\n\n\n:::\n:::\n\n## select\n\n::: {.cell}\n\n```{.r .cell-code}\nsql =\"SELECT * FROM mtcars LIMIT 3\"\ntable=dbGetQuery(con,sql)\ntable\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n     newColName  mpg cyl disp  hp drat    wt  qsec vs am gear carb\n1     Mazda RX4 21.0   6  160 110 3.90 2.620 16.46  0  1    4    4\n2 Mazda RX4 Wag 21.0   6  160 110 3.90 2.875 17.02  0  1    4    4\n3    Datsun 710 22.8   4  108  93 3.85 2.320 18.61  1  1    4    1\n```\n\n\n:::\n:::\n\n## Renaming column\n\n::: {.cell}\n\n```{.r .cell-code}\nsql=\"select mpg as new_mpg from mtcars\"\ntable=dbGetQuery(con,sql)\nhead(table)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  new_mpg\n1    21.0\n2    21.0\n3    22.8\n4    21.4\n5    18.7\n6    18.1\n```\n\n\n:::\n:::\n\n## create column\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsql=\"select mpg+1 as new_mpg,mpg from mtcars\"\ntable=dbGetQuery(con,sql)\nhead(table)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  new_mpg  mpg\n1    22.0 21.0\n2    22.0 21.0\n3    23.8 22.8\n4    22.4 21.4\n5    19.7 18.7\n6    19.1 18.1\n```\n\n\n:::\n:::\n\n\n## Filter rows\n\n::: {.cell}\n\n```{.r .cell-code}\nsql=\"select * from mtcars where hp>100\"\ntable=dbGetQuery(con,sql)\nhead(table)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n         newColName  mpg cyl disp  hp drat    wt  qsec vs am gear carb\n1         Mazda RX4 21.0   6  160 110 3.90 2.620 16.46  0  1    4    4\n2     Mazda RX4 Wag 21.0   6  160 110 3.90 2.875 17.02  0  1    4    4\n3    Hornet 4 Drive 21.4   6  258 110 3.08 3.215 19.44  1  0    3    1\n4 Hornet Sportabout 18.7   8  360 175 3.15 3.440 17.02  0  0    3    2\n5           Valiant 18.1   6  225 105 2.76 3.460 20.22  1  0    3    1\n6        Duster 360 14.3   8  360 245 3.21 3.570 15.84  0  0    3    4\n```\n\n\n:::\n:::\n\n### Filters with AND conditions\n\n::: {.cell}\n\n```{.r .cell-code}\nsql=\"select * from mtcars where hp>100 and drat<3\"\ntable=dbGetQuery(con,sql)\nhead(table)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n          newColName  mpg cyl disp  hp drat   wt  qsec vs am gear carb\n1            Valiant 18.1   6  225 105 2.76 3.46 20.22  1  0    3    1\n2 Cadillac Fleetwood 10.4   8  472 205 2.93 5.25 17.98  0  0    3    4\n3   Dodge Challenger 15.5   8  318 150 2.76 3.52 16.87  0  0    3    2\n```\n\n\n:::\n:::\n\n### Filters with or conditions\n\n::: {.cell}\n\n```{.r .cell-code}\nsql=\"select * from mtcars where hp>100 or drat<3\"\ntable=dbGetQuery(con,sql)\nhead(table)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n         newColName  mpg cyl disp  hp drat    wt  qsec vs am gear carb\n1         Mazda RX4 21.0   6  160 110 3.90 2.620 16.46  0  1    4    4\n2     Mazda RX4 Wag 21.0   6  160 110 3.90 2.875 17.02  0  1    4    4\n3    Hornet 4 Drive 21.4   6  258 110 3.08 3.215 19.44  1  0    3    1\n4 Hornet Sportabout 18.7   8  360 175 3.15 3.440 17.02  0  0    3    2\n5           Valiant 18.1   6  225 105 2.76 3.460 20.22  1  0    3    1\n6        Duster 360 14.3   8  360 245 3.21 3.570 15.84  0  0    3    4\n```\n\n\n:::\n:::\n\n## Append\n\n### append by row\n\n::: {.cell}\n\n```{.r .cell-code}\nsql=\"select * from mtcars union all select * from mtcars \"\ntable=dbGetQuery(con,sql)\nhead(table)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n         newColName  mpg cyl disp  hp drat    wt  qsec vs am gear carb\n1         Mazda RX4 21.0   6  160 110 3.90 2.620 16.46  0  1    4    4\n2     Mazda RX4 Wag 21.0   6  160 110 3.90 2.875 17.02  0  1    4    4\n3        Datsun 710 22.8   4  108  93 3.85 2.320 18.61  1  1    4    1\n4    Hornet 4 Drive 21.4   6  258 110 3.08 3.215 19.44  1  0    3    1\n5 Hornet Sportabout 18.7   8  360 175 3.15 3.440 17.02  0  0    3    2\n6           Valiant 18.1   6  225 105 2.76 3.460 20.22  1  0    3    1\n```\n\n\n:::\n:::\n\n### append by column\n\n### Dropping NA values\n\n### keep NA values\n\n## group by\n\n### average,min,max,sum\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsql=\"select AVG(hp),min(hp),max(hp),sum(hp) from mtcars\"\ntable=dbGetQuery(con,sql)\nhead(table)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n   AVG(hp) min(hp) max(hp) sum(hp)\n1 146.6875      52     335    4694\n```\n\n\n:::\n:::\n\n\n\n### count record and count distinct record\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsql=\"select vs, count(*),count(distinct cyl) from mtcars group by vs\"\ntable=dbGetQuery(con,sql)\nhead(table)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  vs count(*) count(distinct cyl)\n1  0       18                   3\n2  1       14                   2\n```\n\n\n:::\n:::\n\n## order rows\n\n::: {.cell}\n\n```{.r .cell-code}\nsql=\"select * from mtcars order by mpg\"\ntable=dbGetQuery(con,sql)\nhead(table)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n           newColName  mpg cyl disp  hp drat    wt  qsec vs am gear carb\n1  Cadillac Fleetwood 10.4   8  472 205 2.93 5.250 17.98  0  0    3    4\n2 Lincoln Continental 10.4   8  460 215 3.00 5.424 17.82  0  0    3    4\n3          Camaro Z28 13.3   8  350 245 3.73 3.840 15.41  0  0    3    4\n4          Duster 360 14.3   8  360 245 3.21 3.570 15.84  0  0    3    4\n5   Chrysler Imperial 14.7   8  440 230 3.23 5.345 17.42  0  0    3    4\n6       Maserati Bora 15.0   8  301 335 3.54 3.570 14.60  0  1    5    8\n```\n\n\n:::\n:::\n\n### Sort in descending order\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsql=\"select * from mtcars order by mpg desc\"\ntable=dbGetQuery(con,sql)\nhead(table)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n      newColName  mpg cyl  disp  hp drat    wt  qsec vs am gear carb\n1 Toyota Corolla 33.9   4  71.1  65 4.22 1.835 19.90  1  1    4    1\n2       Fiat 128 32.4   4  78.7  66 4.08 2.200 19.47  1  1    4    1\n3    Honda Civic 30.4   4  75.7  52 4.93 1.615 18.52  1  1    4    2\n4   Lotus Europa 30.4   4  95.1 113 3.77 1.513 16.90  1  1    5    2\n5      Fiat X1-9 27.3   4  79.0  66 4.08 1.935 18.90  1  1    4    1\n6  Porsche 914-2 26.0   4 120.3  91 4.43 2.140 16.70  0  1    5    2\n```\n\n\n:::\n:::\n\n### Arrange by multiple variables\n\n::: {.cell}\n\n```{.r .cell-code}\nsql=\"select * from mtcars order by mpg ,cyl\"\ntable=dbGetQuery(con,sql)\nhead(table)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n           newColName  mpg cyl disp  hp drat    wt  qsec vs am gear carb\n1  Cadillac Fleetwood 10.4   8  472 205 2.93 5.250 17.98  0  0    3    4\n2 Lincoln Continental 10.4   8  460 215 3.00 5.424 17.82  0  0    3    4\n3          Camaro Z28 13.3   8  350 245 3.73 3.840 15.41  0  0    3    4\n4          Duster 360 14.3   8  360 245 3.21 3.570 15.84  0  0    3    4\n5   Chrysler Imperial 14.7   8  440 230 3.23 5.345 17.42  0  0    3    4\n6       Maserati Bora 15.0   8  301 335 3.54 3.570 14.60  0  1    5    8\n```\n\n\n:::\n:::\n\n## join\n\n### inner_join\n\n::: {.cell}\n\n```{.r .cell-code}\nsql=\"select a.newColName,a.mpg,b.mpg as new_mpg from mtcars a left join mtcars b on a.newColName=b.newColName\"\n\ntable=dbGetQuery(con,sql)\nhead(table)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n         newColName  mpg new_mpg\n1         Mazda RX4 21.0    21.0\n2     Mazda RX4 Wag 21.0    21.0\n3        Datsun 710 22.8    22.8\n4    Hornet 4 Drive 21.4    21.4\n5 Hornet Sportabout 18.7    18.7\n6           Valiant 18.1    18.1\n```\n\n\n:::\n:::\n\n\n### full join\n\n### left join\n\n### anti join\n\n## Reshape tables\n\n### Gather data long(wide to long)\n\n### Spread data wide (long to wide)\n\n## string\n\n### upper case\n\n### lower case\n\n### match\n\n### concatenation\n\n### replace\n\n### extract\n\n## date\n\n## create table into database\n\n::: {.cell}\n\n```{.r .cell-code}\nsql=\"create table if not exists new_mtcars as select * from mtcars order by mpg ,cyl\"\ndbSendQuery(con,sql)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n<SQLiteResult>\n  SQL  create table if not exists new_mtcars as select * from mtcars order by mpg ,cyl\n  ROWS Fetched: 0 [complete]\n       Changed: 0\n```\n\n\n:::\n\n```{.r .cell-code}\ndbListTables(con)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"iris\"       \"mtcars\"     \"new_mtcars\"\n```\n\n\n:::\n:::\n\n## delete table in database\n\n::: {.cell}\n\n```{.r .cell-code}\nsql=\"drop table if  exists  new_mtcars\"\ndbSendQuery(con,sql)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n<SQLiteResult>\n  SQL  drop table if  exists  new_mtcars\n  ROWS Fetched: 0 [complete]\n       Changed: 0\n```\n\n\n:::\n\n```{.r .cell-code}\ndbListTables(con)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"iris\"   \"mtcars\"\n```\n\n\n:::\n:::\n## edit table in database\n\n\n# Using SQL with R dataframe\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(sqldf)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndata=sqldf(\"select * from mtcars LIMIT 3;\")\ndata\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n     newColName  mpg cyl disp  hp drat    wt  qsec vs am gear carb\n1     Mazda RX4 21.0   6  160 110 3.90 2.620 16.46  0  1    4    4\n2 Mazda RX4 Wag 21.0   6  160 110 3.90 2.875 17.02  0  1    4    4\n3    Datsun 710 22.8   4  108  93 3.85 2.320 18.61  1  1    4    1\n```\n\n\n:::\n:::\n\n\n# reference:\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}