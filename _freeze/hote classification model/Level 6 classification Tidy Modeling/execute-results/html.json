{
  "hash": "058e26e58b6730cec00e3bf9cb2be80e",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Level 6 classification Tidy Modeling\"\nsubtitle: \"with hotel booking data\"\nauthor: \"Tony Duan\"\nexecute:\n  warning: false\n  error: false\nformat:\n  html:\n    toc: true\n    toc-location: right\n    code-fold: show\n    code-tools: true\n    number-sections: true\n    code-block-bg: true\n    code-block-border-left: \"#31BAE9\"\n---\n\n\n\nLevel 6 classification Tidy Modeling: \n\n* using Recipe to down sample.\n* add resamples to estimate the performance of our two models\n* add workflow with tuning\n* add  tuning\n* add workflow set and setting different tuning grid for different model\n\n\n\n\nlogistic glm model \n\ntuning decision tree model with rpart engine(tunning:cost_complexity,tree_depth)\n\nKNN model with knn engine(knn_spec)\n\ntuning XG boost model (tunning:tree_depth , min_n,loss_reduction ,sample_size ,   mtry,learn_rate)\n\ntuning light gbm boost model(tunning:tree_depth , min_n,loss_reduction ,sample_size ,   mtry,learn_rate)\n\n\n# load package\n\n\n::: {.cell}\n\n```{.r .cell-code  code-summary=\"Load Pacakges & Set Options\"}\nlibrary(themis)\nlibrary(tidyverse)      \nlibrary(tidymodels)     \nlibrary(palmerpenguins) # penguin dataset\nlibrary(gt)             # better tables\nlibrary(bonsai)         # tree-based models\nlibrary(conflicted)     # function conflicts\nlibrary(vetiver)\nlibrary(Microsoft365R)\nlibrary(pins)\ntidymodels_prefer()     # handle conflicts\nconflict_prefer(\"penguins\", \"palmerpenguins\")\noptions(tidymodels.dark = TRUE) # dark mode\ntheme_set(theme_bw()) # set default ggplot2 theme\n```\n:::\n\n\n# data preparation\n\n## read data\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\n\nhotels <- readr::read_csv(\"https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-02-11/hotels.csv\")\n\n\nhotel_stays <- hotels %>%\n  filter(is_canceled == 0) %>%\n  mutate(\n    children = case_when(\n      children + babies > 0 ~ \"children\",\n      TRUE ~ \"none\"\n    ),\n    required_car_parking_spaces = case_when(\n      required_car_parking_spaces > 0 ~ \"parking\",\n      TRUE ~ \"none\"\n    )\n  ) %>%\n  select(-is_canceled, -reservation_status, -babies)\n```\n:::\n\n\n\n## data split\n\n\n::: {.cell}\n\n```{.r .cell-code  code-summary=\"Prepare & Split Data\"}\nall_hotels_df <- hotel_stays %>%\n  select(\n    children, hotel, arrival_date_month, meal, adr, adults,\n    required_car_parking_spaces, total_of_special_requests,\n    stays_in_week_nights, stays_in_weekend_nights\n  ) %>%\n  mutate_if(is.character, factor) %>% rename(target_variable=children) %>% mutate(rownum= row_number())\n\nhotels_df=all_hotels_df%>% sample_n(50000) \n\nhold_hotels_df <- anti_join(all_hotels_df, hotels_df, by='rownum')\n\n\n#all_hotels_df=all_hotels_df %>% select(-rownum)\n#hotels_df=hotels_df %>% select(-rownum)\n#all_hotels_df=all_hotels_df %>% select(-rownum)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(1234)\n\ndata_split <- initial_validation_split(data=hotels_df, prop = c(0.7,0.2))\n\ndata_train=training(data_split)  \n\ndata_test=testing(data_split)  \n\ndata_valid=validation(data_split)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndim(data_train)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 35000    11\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndim(data_test)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 5000   11\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndim(data_valid)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 10000    11\n```\n\n\n:::\n:::\n\n\n10 fold for tunning\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(234)\nfolds <- vfold_cv(data_train)\n```\n:::\n\n\n\n\n\n# modeling\n\n## recipe\n\nbecasue the target class is not balance so using downsample\n\n::: {.cell}\n\n```{.r .cell-code}\ndata_rec <- recipe(target_variable ~ ., data = data_train) %>%\n  step_rm(rownum) %>% \n  step_downsample(target_variable) %>%\n  step_dummy(all_nominal(), -all_outcomes()) %>%\n  step_zv(all_numeric()) %>%\n  step_normalize(all_numeric())\n```\n:::\n\n\n\n## model\n\n### decision tree model with cost_complexity and tree_depth to tune\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntune_spec <- \n  decision_tree(\n    cost_complexity = tune(),\n    tree_depth = tune()\n  ) %>% \n  set_engine(\"rpart\") %>% \n  set_mode(\"classification\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ntune_spec |> \n  extract_parameter_set_dials()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nCollection of 2 parameters for tuning\n\n      identifier            type    object\n cost_complexity cost_complexity nparam[+]\n      tree_depth      tree_depth nparam[+]\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndecision_tree_tune_grid <- \n  tune_spec |> \n  extract_parameter_set_dials() |> \n  grid_latin_hypercube(size = 100)\n```\n:::\n\n\n\n### logistic glm model \n\n::: {.cell}\n\n```{.r .cell-code}\nglm_spec <-\n  logistic_reg(penalty = 1) |>\n  set_engine(\"glm\")\n```\n:::\n\n\n\n### KNN model\n\n\n::: {.cell}\n\n```{.r .cell-code}\nknn_spec <- nearest_neighbor() %>%\n  set_engine(\"kknn\") %>%\n  set_mode(\"classification\")\n\nknn_spec\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nK-Nearest Neighbor Model Specification (classification)\n\nComputational engine: kknn \n```\n\n\n:::\n:::\n\n\n\n\n\n### XG Boost tree\n\n\n::: {.cell}\n\n```{.r .cell-code}\nxgb_spec <- boost_tree(\n  trees = 10,\n  tree_depth = tune(), min_n = tune(),\n  loss_reduction = tune(),                     ## first three: model complexity\n  sample_size = tune(),  mtry=tune(),       ## randomness\n  learn_rate = tune()                          ## step size\n) %>%\n  set_engine(\"xgboost\") %>%\n  set_mode(\"classification\")\n\nxgb_spec\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nBoosted Tree Model Specification (classification)\n\nMain Arguments:\n  mtry = tune()\n  trees = 10\n  min_n = tune()\n  tree_depth = tune()\n  learn_rate = tune()\n  loss_reduction = tune()\n  sample_size = tune()\n\nComputational engine: xgboost \n```\n\n\n:::\n:::\n\n\nxgb tunning grid\n\n\n::: {.cell}\n\n```{.r .cell-code}\nxgb_tune_grid= grid_latin_hypercube(\n  tree_depth(),learn_rate(),loss_reduction(),min_n(),\n  sample_size=sample_prop(),finalize(mtry(),data_train),\n  size=50)\n\nhead(xgb_tune_grid)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 6 × 6\n  tree_depth learn_rate loss_reduction min_n sample_size  mtry\n       <int>      <dbl>          <dbl> <int>       <dbl> <int>\n1          2   3.42e- 6       8.02e- 9    32       0.734     3\n2          7   4.05e- 5       2.42e- 1    25       0.393     7\n3         14   4.98e- 4       5.17e-10     4       0.465     3\n4         12   4.33e- 8       8.46e- 7     8       0.485     9\n5         10   4.00e-10       2.81e- 5    14       0.387     9\n6          7   7.24e- 5       8.03e- 2     9       0.105    11\n```\n\n\n:::\n:::\n\n\n\n\n### lightGBM Boost tree\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlightgbm_spec <- boost_tree(\n  trees = 10,\n  tree_depth = tune(), min_n = tune(),\n  loss_reduction = tune(),                     ## first three: model complexity\n  sample_size = tune(),   mtry=tune(),     ## randomness\n  learn_rate = tune()                          ## step size\n) %>%\n  set_engine(\"lightgbm\") %>%\n  set_mode(\"classification\")\n\nlightgbm_spec\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nBoosted Tree Model Specification (classification)\n\nMain Arguments:\n  mtry = tune()\n  trees = 10\n  min_n = tune()\n  tree_depth = tune()\n  learn_rate = tune()\n  loss_reduction = tune()\n  sample_size = tune()\n\nComputational engine: lightgbm \n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nlightgbm_grid= grid_latin_hypercube(\n  tree_depth(),learn_rate(),loss_reduction(),min_n(),\n  sample_size=sample_prop(),finalize(mtry(),data_train),\n  size=50)\n\nhead(lightgbm_grid)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 6 × 6\n  tree_depth learn_rate loss_reduction min_n sample_size  mtry\n       <int>      <dbl>          <dbl> <int>       <dbl> <int>\n1         10   1.14e-10       1.09e- 3    13       0.682     1\n2          6   1.25e- 5       1.81e+ 1    19       0.265     6\n3          2   3.59e- 6       1.55e- 5    18       0.860     8\n4          3   5.01e- 8       2.34e-10    20       0.108     6\n5         15   2.98e- 2       2.05e- 6    21       0.341     5\n6         13   2.28e- 3       2.52e- 7    34       0.124     4\n```\n\n\n:::\n:::\n\n\n\n\n\n\n## workflow set \n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(finetune)\ncntl   <- control_grid(save_pred     = TRUE,\n                       save_workflow = TRUE)\n```\n:::\n\n\n\n\nusing workflow set instead of workflow to combine many models.\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nworkflow_set <-\n  workflow_set(\n    preproc = list(data_rec),\n    models = list(glm   = glm_spec,\n                  tree  = tune_spec,\n                  knn=knn_spec,\n                  xgb=xgb_spec,\n                  lightgbm=lightgbm_spec\n                  )\n  ) %>% option_add(grid = decision_tree_tune_grid, id = \"recipe_tree\")  %>% \n  option_add(grid = xgb_tune_grid, id = \"recipe_xgb\")  %>% \n  option_add(grid = lightgbm_grid, id = \"recipe_lightgbm\") \n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nworkflow_set %>%\n  option_add_parameters()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A workflow set/tibble: 5 × 4\n  wflow_id        info             option    result    \n  <chr>           <list>           <list>    <list>    \n1 recipe_glm      <tibble [1 × 4]> <opts[0]> <list [0]>\n2 recipe_tree     <tibble [1 × 4]> <opts[2]> <list [0]>\n3 recipe_knn      <tibble [1 × 4]> <opts[0]> <list [0]>\n4 recipe_xgb      <tibble [1 × 4]> <opts[2]> <list [0]>\n5 recipe_lightgbm <tibble [1 × 4]> <opts[2]> <list [0]>\n```\n\n\n:::\n:::\n\n\n\n## training and tunning\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(finetune)\ndoParallel::registerDoParallel()\n\nmodel_set_res = workflow_set  %>% \n  workflow_map(\n              grid = 20,\n               resamples = folds,\n               control = cntl\n  )\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nrank_results(model_set_res,\n             rank_metric = \"roc_auc\",\n             select_best = TRUE)  %>% \n  gt()\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div id=\"pafhogemzd\" style=\"padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;\">\n<style>#pafhogemzd table {\n  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';\n  -webkit-font-smoothing: antialiased;\n  -moz-osx-font-smoothing: grayscale;\n}\n\n#pafhogemzd thead, #pafhogemzd tbody, #pafhogemzd tfoot, #pafhogemzd tr, #pafhogemzd td, #pafhogemzd th {\n  border-style: none;\n}\n\n#pafhogemzd p {\n  margin: 0;\n  padding: 0;\n}\n\n#pafhogemzd .gt_table {\n  display: table;\n  border-collapse: collapse;\n  line-height: normal;\n  margin-left: auto;\n  margin-right: auto;\n  color: #333333;\n  font-size: 16px;\n  font-weight: normal;\n  font-style: normal;\n  background-color: #FFFFFF;\n  width: auto;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #A8A8A8;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #A8A8A8;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n}\n\n#pafhogemzd .gt_caption {\n  padding-top: 4px;\n  padding-bottom: 4px;\n}\n\n#pafhogemzd .gt_title {\n  color: #333333;\n  font-size: 125%;\n  font-weight: initial;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-color: #FFFFFF;\n  border-bottom-width: 0;\n}\n\n#pafhogemzd .gt_subtitle {\n  color: #333333;\n  font-size: 85%;\n  font-weight: initial;\n  padding-top: 3px;\n  padding-bottom: 5px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-color: #FFFFFF;\n  border-top-width: 0;\n}\n\n#pafhogemzd .gt_heading {\n  background-color: #FFFFFF;\n  text-align: center;\n  border-bottom-color: #FFFFFF;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#pafhogemzd .gt_bottom_border {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#pafhogemzd .gt_col_headings {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#pafhogemzd .gt_col_heading {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 6px;\n  padding-left: 5px;\n  padding-right: 5px;\n  overflow-x: hidden;\n}\n\n#pafhogemzd .gt_column_spanner_outer {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  padding-top: 0;\n  padding-bottom: 0;\n  padding-left: 4px;\n  padding-right: 4px;\n}\n\n#pafhogemzd .gt_column_spanner_outer:first-child {\n  padding-left: 0;\n}\n\n#pafhogemzd .gt_column_spanner_outer:last-child {\n  padding-right: 0;\n}\n\n#pafhogemzd .gt_column_spanner {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 5px;\n  overflow-x: hidden;\n  display: inline-block;\n  width: 100%;\n}\n\n#pafhogemzd .gt_spanner_row {\n  border-bottom-style: hidden;\n}\n\n#pafhogemzd .gt_group_heading {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  text-align: left;\n}\n\n#pafhogemzd .gt_empty_group_heading {\n  padding: 0.5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: middle;\n}\n\n#pafhogemzd .gt_from_md > :first-child {\n  margin-top: 0;\n}\n\n#pafhogemzd .gt_from_md > :last-child {\n  margin-bottom: 0;\n}\n\n#pafhogemzd .gt_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  margin: 10px;\n  border-top-style: solid;\n  border-top-width: 1px;\n  border-top-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  overflow-x: hidden;\n}\n\n#pafhogemzd .gt_stub {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#pafhogemzd .gt_stub_row_group {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n  vertical-align: top;\n}\n\n#pafhogemzd .gt_row_group_first td {\n  border-top-width: 2px;\n}\n\n#pafhogemzd .gt_row_group_first th {\n  border-top-width: 2px;\n}\n\n#pafhogemzd .gt_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#pafhogemzd .gt_first_summary_row {\n  border-top-style: solid;\n  border-top-color: #D3D3D3;\n}\n\n#pafhogemzd .gt_first_summary_row.thick {\n  border-top-width: 2px;\n}\n\n#pafhogemzd .gt_last_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#pafhogemzd .gt_grand_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#pafhogemzd .gt_first_grand_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-style: double;\n  border-top-width: 6px;\n  border-top-color: #D3D3D3;\n}\n\n#pafhogemzd .gt_last_grand_summary_row_top {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: double;\n  border-bottom-width: 6px;\n  border-bottom-color: #D3D3D3;\n}\n\n#pafhogemzd .gt_striped {\n  background-color: rgba(128, 128, 128, 0.05);\n}\n\n#pafhogemzd .gt_table_body {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#pafhogemzd .gt_footnotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#pafhogemzd .gt_footnote {\n  margin: 0px;\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#pafhogemzd .gt_sourcenotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#pafhogemzd .gt_sourcenote {\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#pafhogemzd .gt_left {\n  text-align: left;\n}\n\n#pafhogemzd .gt_center {\n  text-align: center;\n}\n\n#pafhogemzd .gt_right {\n  text-align: right;\n  font-variant-numeric: tabular-nums;\n}\n\n#pafhogemzd .gt_font_normal {\n  font-weight: normal;\n}\n\n#pafhogemzd .gt_font_bold {\n  font-weight: bold;\n}\n\n#pafhogemzd .gt_font_italic {\n  font-style: italic;\n}\n\n#pafhogemzd .gt_super {\n  font-size: 65%;\n}\n\n#pafhogemzd .gt_footnote_marks {\n  font-size: 75%;\n  vertical-align: 0.4em;\n  position: initial;\n}\n\n#pafhogemzd .gt_asterisk {\n  font-size: 100%;\n  vertical-align: 0;\n}\n\n#pafhogemzd .gt_indent_1 {\n  text-indent: 5px;\n}\n\n#pafhogemzd .gt_indent_2 {\n  text-indent: 10px;\n}\n\n#pafhogemzd .gt_indent_3 {\n  text-indent: 15px;\n}\n\n#pafhogemzd .gt_indent_4 {\n  text-indent: 20px;\n}\n\n#pafhogemzd .gt_indent_5 {\n  text-indent: 25px;\n}\n</style>\n<table class=\"gt_table\" data-quarto-disable-processing=\"false\" data-quarto-bootstrap=\"false\">\n  <thead>\n    <tr class=\"gt_col_headings\">\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_left\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"wflow_id\">wflow_id</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_left\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\".config\">.config</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_left\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\".metric\">.metric</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"mean\">mean</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"std_err\">std_err</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"n\">n</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_left\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"preprocessor\">preprocessor</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_left\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"model\">model</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"rank\">rank</th>\n    </tr>\n  </thead>\n  <tbody class=\"gt_table_body\">\n    <tr><td headers=\"wflow_id\" class=\"gt_row gt_left\">recipe_xgb</td>\n<td headers=\".config\" class=\"gt_row gt_left\">Preprocessor1_Model19</td>\n<td headers=\".metric\" class=\"gt_row gt_left\">accuracy</td>\n<td headers=\"mean\" class=\"gt_row gt_right\">0.7650286</td>\n<td headers=\"std_err\" class=\"gt_row gt_right\">0.003452614</td>\n<td headers=\"n\" class=\"gt_row gt_right\">10</td>\n<td headers=\"preprocessor\" class=\"gt_row gt_left\">recipe</td>\n<td headers=\"model\" class=\"gt_row gt_left\">boost_tree</td>\n<td headers=\"rank\" class=\"gt_row gt_right\">1</td></tr>\n    <tr><td headers=\"wflow_id\" class=\"gt_row gt_left\">recipe_xgb</td>\n<td headers=\".config\" class=\"gt_row gt_left\">Preprocessor1_Model19</td>\n<td headers=\".metric\" class=\"gt_row gt_left\">roc_auc</td>\n<td headers=\"mean\" class=\"gt_row gt_right\">0.8412516</td>\n<td headers=\"std_err\" class=\"gt_row gt_right\">0.004250130</td>\n<td headers=\"n\" class=\"gt_row gt_right\">10</td>\n<td headers=\"preprocessor\" class=\"gt_row gt_left\">recipe</td>\n<td headers=\"model\" class=\"gt_row gt_left\">boost_tree</td>\n<td headers=\"rank\" class=\"gt_row gt_right\">1</td></tr>\n    <tr><td headers=\"wflow_id\" class=\"gt_row gt_left\">recipe_lightgbm</td>\n<td headers=\".config\" class=\"gt_row gt_left\">Preprocessor1_Model05</td>\n<td headers=\".metric\" class=\"gt_row gt_left\">accuracy</td>\n<td headers=\"mean\" class=\"gt_row gt_right\">0.7576571</td>\n<td headers=\"std_err\" class=\"gt_row gt_right\">0.003629009</td>\n<td headers=\"n\" class=\"gt_row gt_right\">10</td>\n<td headers=\"preprocessor\" class=\"gt_row gt_left\">recipe</td>\n<td headers=\"model\" class=\"gt_row gt_left\">boost_tree</td>\n<td headers=\"rank\" class=\"gt_row gt_right\">2</td></tr>\n    <tr><td headers=\"wflow_id\" class=\"gt_row gt_left\">recipe_lightgbm</td>\n<td headers=\".config\" class=\"gt_row gt_left\">Preprocessor1_Model05</td>\n<td headers=\".metric\" class=\"gt_row gt_left\">roc_auc</td>\n<td headers=\"mean\" class=\"gt_row gt_right\">0.8377707</td>\n<td headers=\"std_err\" class=\"gt_row gt_right\">0.005030341</td>\n<td headers=\"n\" class=\"gt_row gt_right\">10</td>\n<td headers=\"preprocessor\" class=\"gt_row gt_left\">recipe</td>\n<td headers=\"model\" class=\"gt_row gt_left\">boost_tree</td>\n<td headers=\"rank\" class=\"gt_row gt_right\">2</td></tr>\n    <tr><td headers=\"wflow_id\" class=\"gt_row gt_left\">recipe_tree</td>\n<td headers=\".config\" class=\"gt_row gt_left\">Preprocessor1_Model06</td>\n<td headers=\".metric\" class=\"gt_row gt_left\">accuracy</td>\n<td headers=\"mean\" class=\"gt_row gt_right\">0.7471714</td>\n<td headers=\"std_err\" class=\"gt_row gt_right\">0.005203601</td>\n<td headers=\"n\" class=\"gt_row gt_right\">10</td>\n<td headers=\"preprocessor\" class=\"gt_row gt_left\">recipe</td>\n<td headers=\"model\" class=\"gt_row gt_left\">decision_tree</td>\n<td headers=\"rank\" class=\"gt_row gt_right\">3</td></tr>\n    <tr><td headers=\"wflow_id\" class=\"gt_row gt_left\">recipe_tree</td>\n<td headers=\".config\" class=\"gt_row gt_left\">Preprocessor1_Model06</td>\n<td headers=\".metric\" class=\"gt_row gt_left\">roc_auc</td>\n<td headers=\"mean\" class=\"gt_row gt_right\">0.8223165</td>\n<td headers=\"std_err\" class=\"gt_row gt_right\">0.007248099</td>\n<td headers=\"n\" class=\"gt_row gt_right\">10</td>\n<td headers=\"preprocessor\" class=\"gt_row gt_left\">recipe</td>\n<td headers=\"model\" class=\"gt_row gt_left\">decision_tree</td>\n<td headers=\"rank\" class=\"gt_row gt_right\">3</td></tr>\n    <tr><td headers=\"wflow_id\" class=\"gt_row gt_left\">recipe_glm</td>\n<td headers=\".config\" class=\"gt_row gt_left\">Preprocessor1_Model1</td>\n<td headers=\".metric\" class=\"gt_row gt_left\">accuracy</td>\n<td headers=\"mean\" class=\"gt_row gt_right\">0.7663143</td>\n<td headers=\"std_err\" class=\"gt_row gt_right\">0.001708164</td>\n<td headers=\"n\" class=\"gt_row gt_right\">10</td>\n<td headers=\"preprocessor\" class=\"gt_row gt_left\">recipe</td>\n<td headers=\"model\" class=\"gt_row gt_left\">logistic_reg</td>\n<td headers=\"rank\" class=\"gt_row gt_right\">4</td></tr>\n    <tr><td headers=\"wflow_id\" class=\"gt_row gt_left\">recipe_glm</td>\n<td headers=\".config\" class=\"gt_row gt_left\">Preprocessor1_Model1</td>\n<td headers=\".metric\" class=\"gt_row gt_left\">roc_auc</td>\n<td headers=\"mean\" class=\"gt_row gt_right\">0.8114071</td>\n<td headers=\"std_err\" class=\"gt_row gt_right\">0.002863346</td>\n<td headers=\"n\" class=\"gt_row gt_right\">10</td>\n<td headers=\"preprocessor\" class=\"gt_row gt_left\">recipe</td>\n<td headers=\"model\" class=\"gt_row gt_left\">logistic_reg</td>\n<td headers=\"rank\" class=\"gt_row gt_right\">4</td></tr>\n    <tr><td headers=\"wflow_id\" class=\"gt_row gt_left\">recipe_knn</td>\n<td headers=\".config\" class=\"gt_row gt_left\">Preprocessor1_Model1</td>\n<td headers=\".metric\" class=\"gt_row gt_left\">accuracy</td>\n<td headers=\"mean\" class=\"gt_row gt_right\">0.7390857</td>\n<td headers=\"std_err\" class=\"gt_row gt_right\">0.001727358</td>\n<td headers=\"n\" class=\"gt_row gt_right\">10</td>\n<td headers=\"preprocessor\" class=\"gt_row gt_left\">recipe</td>\n<td headers=\"model\" class=\"gt_row gt_left\">nearest_neighbor</td>\n<td headers=\"rank\" class=\"gt_row gt_right\">5</td></tr>\n    <tr><td headers=\"wflow_id\" class=\"gt_row gt_left\">recipe_knn</td>\n<td headers=\".config\" class=\"gt_row gt_left\">Preprocessor1_Model1</td>\n<td headers=\".metric\" class=\"gt_row gt_left\">roc_auc</td>\n<td headers=\"mean\" class=\"gt_row gt_right\">0.7956658</td>\n<td headers=\"std_err\" class=\"gt_row gt_right\">0.005035380</td>\n<td headers=\"n\" class=\"gt_row gt_right\">10</td>\n<td headers=\"preprocessor\" class=\"gt_row gt_left\">recipe</td>\n<td headers=\"model\" class=\"gt_row gt_left\">nearest_neighbor</td>\n<td headers=\"rank\" class=\"gt_row gt_right\">5</td></tr>\n  </tbody>\n  \n  \n</table>\n</div>\n```\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nmodel_set_res |> autoplot()\n```\n\n::: {.cell-output-display}\n![](Level-6-classification-Tidy-Modeling_files/figure-html/unnamed-chunk-24-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nmodel_set_res |> autoplot( id= 'recipe_xgb')\n```\n\n::: {.cell-output-display}\n![](Level-6-classification-Tidy-Modeling_files/figure-html/unnamed-chunk-25-1.png){width=672}\n:::\n:::\n\n\nselect best model:logistic glm model \n\n::: {.cell}\n\n```{.r .cell-code}\nbest_model_id <- \"recipe_xgb\"\n```\n:::\n\n\nselect best parameters\n\n::: {.cell}\n\n```{.r .cell-code}\nbest_fit <-\n  model_set_res |>\n  extract_workflow_set_result(best_model_id) |>\n  select_best(metric = \"accuracy\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# create workflow for best model\nfinal_workflow <-\n  model_set_res |>\n  extract_workflow(best_model_id) |>\n  finalize_workflow(best_fit)\n```\n:::\n\n\n\n\n\n\n## last fit\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfinal_fit <-\n  final_workflow |>\n  last_fit(data_split)\n```\n:::\n\n\n\n# model result\n\n## Evaluate\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfinal_fit %>%\n  collect_metrics()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 2 × 4\n  .metric  .estimator .estimate .config             \n  <chr>    <chr>          <dbl> <chr>               \n1 accuracy binary         0.784 Preprocessor1_Model1\n2 roc_auc  binary         0.823 Preprocessor1_Model1\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nall_metrics <- metric_set(accuracy, recall, precision, f_meas, kap, sens, spec)\n\na=final_fit %>% collect_predictions()\n\nall_metrics(a, truth = target_variable,estimate = .pred_class)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 7 × 3\n  .metric   .estimator .estimate\n  <chr>     <chr>          <dbl>\n1 accuracy  binary         0.784\n2 recall    binary         0.714\n3 precision binary         0.217\n4 f_meas    binary         0.333\n5 kap       binary         0.246\n6 sens      binary         0.714\n7 spec      binary         0.790\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nfinal_fit %>%\n  collect_predictions() %>% \n  roc_curve(target_variable, .pred_children) %>% \n  autoplot()\n```\n\n::: {.cell-output-display}\n![](Level-6-classification-Tidy-Modeling_files/figure-html/unnamed-chunk-32-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nfinal_tree <- extract_workflow(final_fit)\nfinal_tree\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n══ Workflow [trained] ══════════════════════════════════════════════════════════\nPreprocessor: Recipe\nModel: boost_tree()\n\n── Preprocessor ────────────────────────────────────────────────────────────────\n5 Recipe Steps\n\n• step_rm()\n• step_downsample()\n• step_dummy()\n• step_zv()\n• step_normalize()\n\n── Model ───────────────────────────────────────────────────────────────────────\n##### xgb.Booster\nraw: 25.2 Kb \ncall:\n  xgboost::xgb.train(params = list(eta = 0.0899069436737191, max_depth = 5L, \n    gamma = 0.832337637488916, colsample_bytree = 1, colsample_bynode = 0.590909090909091, \n    min_child_weight = 4L, subsample = 0.618058206671849), data = x$data, \n    nrounds = 10, watchlist = x$watchlist, verbose = 0, nthread = 1, \n    objective = \"binary:logistic\")\nparams (as set within xgb.train):\n  eta = \"0.0899069436737191\", max_depth = \"5\", gamma = \"0.832337637488916\", colsample_bytree = \"1\", colsample_bynode = \"0.590909090909091\", min_child_weight = \"4\", subsample = \"0.618058206671849\", nthread = \"1\", objective = \"binary:logistic\", validate_parameters = \"TRUE\"\nxgb.attributes:\n  niter\ncallbacks:\n  cb.evaluation.log()\n# of features: 22 \nniter: 10\nnfeatures : 22 \nevaluation_log:\n     iter training_logloss\n    <num>            <num>\n        1        0.6673541\n        2        0.6433716\n---                       \n        9        0.5497512\n       10        0.5410508\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(vip)\n\nfinal_tree %>% \n  extract_fit_parsnip() %>% \n  vip()\n```\n\n::: {.cell-output-display}\n![](Level-6-classification-Tidy-Modeling_files/figure-html/unnamed-chunk-34-1.png){width=672}\n:::\n:::\n\n\n\n\n## save model\n\ncheck model size\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(lobstr)\nobj_size(final_tree)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n3.43 MB\n```\n\n\n:::\n:::\n\n\nbundle and save model\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(bundle)\nmodel_bundle <- bundle(final_tree)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nsaveRDS(model_bundle,'level 6 classification decision tree hotel model.RDS')\n```\n:::\n\n\n## make predication\n\nload model and unbundle\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmodel=readRDS('level 6 classification decision tree hotel model.RDS')\n\nmodel <- unbundle(model)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nfinal_prediction=predict(model,data_valid)\n\nhead(final_prediction)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 6 × 1\n  .pred_class\n  <fct>      \n1 none       \n2 none       \n3 children   \n4 none       \n5 none       \n6 none       \n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nfinal_prediction_data=cbind(data_valid,final_prediction)\n\nconf_mat(final_prediction_data, truth = target_variable,\n    estimate = .pred_class)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n          Truth\nPrediction children none\n  children      564 2007\n  none          230 7199\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\naccuracy(final_prediction_data, truth = target_variable, estimate = .pred_class)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 1 × 3\n  .metric  .estimator .estimate\n  <chr>    <chr>          <dbl>\n1 accuracy binary         0.776\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nfinal_prediction_data %>% group_by(target_variable)%>% count()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 2 × 2\n# Groups:   target_variable [2]\n  target_variable     n\n  <fct>           <int>\n1 children          794\n2 none             9206\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nfinal_prediction_data %>% group_by(.pred_class) %>% count()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 2 × 2\n# Groups:   .pred_class [2]\n  .pred_class     n\n  <fct>       <int>\n1 children     2571\n2 none         7429\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nconf_mat(final_prediction_data, truth = target_variable,\n    estimate = .pred_class)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n          Truth\nPrediction children none\n  children      564 2007\n  none          230 7199\n```\n\n\n:::\n:::\n\n\n# reference:\n\n\nhttps://www.tmwr.org\n\nhttps://www.youtube.com/watch?v=IzjmuGJgwKQ\n\nhttps://www.youtube.com/watch?v=_e0NFIaHY2c\n\n\n",
    "supporting": [
      "Level-6-classification-Tidy-Modeling_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}