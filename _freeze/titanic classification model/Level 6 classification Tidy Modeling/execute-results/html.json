{
  "hash": "fb8b90fc7fbaf5f3861575f8931c4655",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Level 6 classification Tidy Modeling\"\nsubtitle: \"with titanic data\"\nauthor: \"Tony Duan\"\nexecute:\n  warning: false\n  error: false\nformat:\n  html:\n    toc: true\n    toc-location: right\n    code-fold: show\n    code-tools: true\n    number-sections: true\n    code-block-bg: true\n    code-block-border-left: \"#31BAE9\"\n---\n\n\n\nLevel 6 classification Tidy Modeling: \n\n* using Recipe.\n* add resamples to estimate the performance of our two models\n* add workflow with tuning\n* add quick tuning\n* add workflow set and setting different tuning grid for different model\n\n# load package\n\n\n::: {.cell}\n\n```{.r .cell-code  code-summary=\"Load Pacakges & Set Options\"}\nlibrary(themis)\nlibrary(tidyverse)      \nlibrary(tidymodels)     \nlibrary(palmerpenguins) # penguin dataset\nlibrary(gt)             # better tables\nlibrary(bonsai)         # tree-based models\nlibrary(conflicted)     # function conflicts\nlibrary(vetiver)\nlibrary(Microsoft365R)\nlibrary(pins)\ntidymodels_prefer()     # handle conflicts\nconflict_prefer(\"penguins\", \"palmerpenguins\")\noptions(tidymodels.dark = TRUE) # dark mode\ntheme_set(theme_bw()) # set default ggplot2 theme\n```\n:::\n\n\n# data preparation\n\n## read data\nhttps://www.kaggle.com/competitions/titanic/data\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\ntrain = read_csv(\"data/train.csv\")\n\ntest=read_csv(\"data/test.csv\")\n```\n:::\n\n\n\n## data split\n\n\n::: {.cell}\n\n```{.r .cell-code  code-summary=\"Prepare & Split Data\"}\ntrain_df <- train %>%mutate(Survived=as.factor(Survived)) %>% select(-Name) %>% \n\n  mutate_if(is.character, factor) %>% rename(target_variable=Survived)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(1234)\n\ndata_split <- initial_validation_split(data=train_df, prop = c(0.7,0.1))\n\ndata_train=training(data_split)  \n\ndata_test=testing(data_split)  \n\ndata_valid=validation(data_split)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndim(data_train)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 623  11\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndim(data_test)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 179  11\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndim(data_valid)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 89 11\n```\n\n\n:::\n:::\n\n\n# modeling\n\n## recipe\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata_rec <- recipe(target_variable ~ ., data = data_train) %>%\n  step_impute_knn(all_predictors(), neighbors = 5) %>%\n  #step_downsample(target_variable) %>%\n  #step_novel(Ticket) %>%\n  step_rm(Ticket) %>% \n  step_dummy(all_nominal(), -all_outcomes()) %>%\n  step_zv(all_numeric()) %>%\n  step_normalize(all_numeric())\n```\n:::\n\n\n\n## model\n\n### decision tree model with cost_complexity and tree_depth to tune\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntune_spec <- \n  decision_tree(\n    cost_complexity = tune(),\n    tree_depth = tune()\n  ) %>% \n  set_engine(\"rpart\") %>% \n  set_mode(\"classification\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ntune_spec |> \n  extract_parameter_set_dials()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nCollection of 2 parameters for tuning\n\n      identifier            type    object\n cost_complexity cost_complexity nparam[+]\n      tree_depth      tree_depth nparam[+]\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndecision_tree_tune_grid <- \n  tune_spec |> \n  extract_parameter_set_dials() |> \n  grid_latin_hypercube(size = 100)\n```\n:::\n\n\n\n### logistic glm model \n\n::: {.cell}\n\n```{.r .cell-code}\nglm_spec <-\n  logistic_reg(penalty = 1) |>\n  set_engine(\"glm\")\n```\n:::\n\n\n\n### KNN model\n\n\n::: {.cell}\n\n```{.r .cell-code}\nknn_spec <- nearest_neighbor() %>%\n  set_engine(\"kknn\") %>%\n  set_mode(\"classification\")\n\nknn_spec\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nK-Nearest Neighbor Model Specification (classification)\n\nComputational engine: kknn \n```\n\n\n:::\n:::\n\n\n\n\n\n### XG Boost tree\n\n\n::: {.cell}\n\n```{.r .cell-code}\nxgb_spec <- boost_tree(\n  trees = 10,\n  tree_depth = tune(), min_n = tune(),\n  loss_reduction = tune(),                     ## first three: model complexity\n  sample_size = tune(),  mtry=tune(),       ## randomness\n  learn_rate = tune()                          ## step size\n) %>%\n  set_engine(\"xgboost\") %>%\n  set_mode(\"classification\")\n\nxgb_spec\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nBoosted Tree Model Specification (classification)\n\nMain Arguments:\n  mtry = tune()\n  trees = 10\n  min_n = tune()\n  tree_depth = tune()\n  learn_rate = tune()\n  loss_reduction = tune()\n  sample_size = tune()\n\nComputational engine: xgboost \n```\n\n\n:::\n:::\n\n\nxgb tunning grid\n\n\n::: {.cell}\n\n```{.r .cell-code}\nxgb_tune_grid= grid_latin_hypercube(\n  tree_depth(),learn_rate(),loss_reduction(),min_n(),\n  sample_size=sample_prop(),finalize(mtry(),data_train),\n  size=50)\n\nhead(xgb_tune_grid)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 6 × 6\n  tree_depth learn_rate loss_reduction min_n sample_size  mtry\n       <int>      <dbl>          <dbl> <int>       <dbl> <int>\n1          6   3.33e- 5       2.32e+ 1    34       0.746     2\n2          6   6.19e- 4       2.32e- 2    22       0.580     5\n3          5   3.66e- 2       4.50e-10    24       0.949     1\n4          9   9.47e-10       2.06e- 5     2       0.340    11\n5          9   9.81e- 2       5.39e- 8     7       0.787     3\n6         12   2.50e- 6       6.99e- 3    16       0.151     5\n```\n\n\n:::\n:::\n\n\n\n\n### lightGBM Boost tree\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlightgbm_spec <- boost_tree(\n  trees = 10,\n  tree_depth = tune(), min_n = tune(),\n  loss_reduction = tune(),                     ## first three: model complexity\n  sample_size = tune(),   mtry=tune(),     ## randomness\n  learn_rate = tune()                          ## step size\n) %>%\n  set_engine(\"lightgbm\") %>%\n  set_mode(\"classification\")\n\nlightgbm_spec\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nBoosted Tree Model Specification (classification)\n\nMain Arguments:\n  mtry = tune()\n  trees = 10\n  min_n = tune()\n  tree_depth = tune()\n  learn_rate = tune()\n  loss_reduction = tune()\n  sample_size = tune()\n\nComputational engine: lightgbm \n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nlightgbm_grid= grid_latin_hypercube(\n  tree_depth(),learn_rate(),loss_reduction(),min_n(),\n  sample_size=sample_prop(),finalize(mtry(),data_train),\n  size=50)\n\nhead(lightgbm_grid)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 6 × 6\n  tree_depth   learn_rate loss_reduction min_n sample_size  mtry\n       <int>        <dbl>          <dbl> <int>       <dbl> <int>\n1         12 0.00000156         6.09e-10    14       0.917     6\n2          3 0.0134             5.25e- 6    22       0.151     1\n3          2 0.0000000634       1.79e-10    15       0.132     5\n4          6 0.0206             1.84e- 5    19       0.863     9\n5          6 0.00000358         4.57e- 1    38       0.818     8\n6          4 0.00384            3.55e- 4    15       0.552     4\n```\n\n\n:::\n:::\n\n\n\n\n\n\n## workflow set \n\nusing control_race instead of control_grid\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(finetune)\ncntl   <- control_race(save_pred     = TRUE,\n                       save_workflow = TRUE)\n```\n:::\n\n\n\n\nusing workflow set instead of workflow to combine many models.\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nworkflow_set <-\n  workflow_set(\n    preproc = list(data_rec),\n    models = list(glm   = glm_spec,\n                  tree  = tune_spec,\n                  knn=knn_spec,\n                  xgb=xgb_spec,\n                  lightgbm=lightgbm_spec\n                  )\n  ) %>% option_add(grid = decision_tree_tune_grid, id = \"recipe_tree\")  %>% \n  option_add(grid = xgb_tune_grid, id = \"recipe_xgb\")  %>% \n  option_add(grid = lightgbm_grid, id = \"recipe_lightgbm\") \n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nworkflow_set %>%\n  option_add_parameters()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A workflow set/tibble: 5 × 4\n  wflow_id        info             option    result    \n  <chr>           <list>           <list>    <list>    \n1 recipe_glm      <tibble [1 × 4]> <opts[0]> <list [0]>\n2 recipe_tree     <tibble [1 × 4]> <opts[2]> <list [0]>\n3 recipe_knn      <tibble [1 × 4]> <opts[0]> <list [0]>\n4 recipe_xgb      <tibble [1 × 4]> <opts[2]> <list [0]>\n5 recipe_lightgbm <tibble [1 × 4]> <opts[2]> <list [0]>\n```\n\n\n:::\n:::\n\n\n10 fold for tunning\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(234)\nfolds <- vfold_cv(data_train)\n```\n:::\n\n\n## training and tunning\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(finetune)\ndoParallel::registerDoParallel()\n\nmodel_set_res = workflow_set  %>% \n  workflow_map(\n              grid = 20,\n               resamples = folds,\n               control = cntl\n  )\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nrank_results(model_set_res,\n             rank_metric = \"roc_auc\",\n             select_best = TRUE)  %>% \n  gt()\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div id=\"vfzgxuxaof\" style=\"padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;\">\n<style>#vfzgxuxaof table {\n  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';\n  -webkit-font-smoothing: antialiased;\n  -moz-osx-font-smoothing: grayscale;\n}\n\n#vfzgxuxaof thead, #vfzgxuxaof tbody, #vfzgxuxaof tfoot, #vfzgxuxaof tr, #vfzgxuxaof td, #vfzgxuxaof th {\n  border-style: none;\n}\n\n#vfzgxuxaof p {\n  margin: 0;\n  padding: 0;\n}\n\n#vfzgxuxaof .gt_table {\n  display: table;\n  border-collapse: collapse;\n  line-height: normal;\n  margin-left: auto;\n  margin-right: auto;\n  color: #333333;\n  font-size: 16px;\n  font-weight: normal;\n  font-style: normal;\n  background-color: #FFFFFF;\n  width: auto;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #A8A8A8;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #A8A8A8;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n}\n\n#vfzgxuxaof .gt_caption {\n  padding-top: 4px;\n  padding-bottom: 4px;\n}\n\n#vfzgxuxaof .gt_title {\n  color: #333333;\n  font-size: 125%;\n  font-weight: initial;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-color: #FFFFFF;\n  border-bottom-width: 0;\n}\n\n#vfzgxuxaof .gt_subtitle {\n  color: #333333;\n  font-size: 85%;\n  font-weight: initial;\n  padding-top: 3px;\n  padding-bottom: 5px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-color: #FFFFFF;\n  border-top-width: 0;\n}\n\n#vfzgxuxaof .gt_heading {\n  background-color: #FFFFFF;\n  text-align: center;\n  border-bottom-color: #FFFFFF;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#vfzgxuxaof .gt_bottom_border {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#vfzgxuxaof .gt_col_headings {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#vfzgxuxaof .gt_col_heading {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 6px;\n  padding-left: 5px;\n  padding-right: 5px;\n  overflow-x: hidden;\n}\n\n#vfzgxuxaof .gt_column_spanner_outer {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  padding-top: 0;\n  padding-bottom: 0;\n  padding-left: 4px;\n  padding-right: 4px;\n}\n\n#vfzgxuxaof .gt_column_spanner_outer:first-child {\n  padding-left: 0;\n}\n\n#vfzgxuxaof .gt_column_spanner_outer:last-child {\n  padding-right: 0;\n}\n\n#vfzgxuxaof .gt_column_spanner {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 5px;\n  overflow-x: hidden;\n  display: inline-block;\n  width: 100%;\n}\n\n#vfzgxuxaof .gt_spanner_row {\n  border-bottom-style: hidden;\n}\n\n#vfzgxuxaof .gt_group_heading {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  text-align: left;\n}\n\n#vfzgxuxaof .gt_empty_group_heading {\n  padding: 0.5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: middle;\n}\n\n#vfzgxuxaof .gt_from_md > :first-child {\n  margin-top: 0;\n}\n\n#vfzgxuxaof .gt_from_md > :last-child {\n  margin-bottom: 0;\n}\n\n#vfzgxuxaof .gt_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  margin: 10px;\n  border-top-style: solid;\n  border-top-width: 1px;\n  border-top-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  overflow-x: hidden;\n}\n\n#vfzgxuxaof .gt_stub {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#vfzgxuxaof .gt_stub_row_group {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n  vertical-align: top;\n}\n\n#vfzgxuxaof .gt_row_group_first td {\n  border-top-width: 2px;\n}\n\n#vfzgxuxaof .gt_row_group_first th {\n  border-top-width: 2px;\n}\n\n#vfzgxuxaof .gt_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#vfzgxuxaof .gt_first_summary_row {\n  border-top-style: solid;\n  border-top-color: #D3D3D3;\n}\n\n#vfzgxuxaof .gt_first_summary_row.thick {\n  border-top-width: 2px;\n}\n\n#vfzgxuxaof .gt_last_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#vfzgxuxaof .gt_grand_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#vfzgxuxaof .gt_first_grand_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-style: double;\n  border-top-width: 6px;\n  border-top-color: #D3D3D3;\n}\n\n#vfzgxuxaof .gt_last_grand_summary_row_top {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: double;\n  border-bottom-width: 6px;\n  border-bottom-color: #D3D3D3;\n}\n\n#vfzgxuxaof .gt_striped {\n  background-color: rgba(128, 128, 128, 0.05);\n}\n\n#vfzgxuxaof .gt_table_body {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#vfzgxuxaof .gt_footnotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#vfzgxuxaof .gt_footnote {\n  margin: 0px;\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#vfzgxuxaof .gt_sourcenotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#vfzgxuxaof .gt_sourcenote {\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#vfzgxuxaof .gt_left {\n  text-align: left;\n}\n\n#vfzgxuxaof .gt_center {\n  text-align: center;\n}\n\n#vfzgxuxaof .gt_right {\n  text-align: right;\n  font-variant-numeric: tabular-nums;\n}\n\n#vfzgxuxaof .gt_font_normal {\n  font-weight: normal;\n}\n\n#vfzgxuxaof .gt_font_bold {\n  font-weight: bold;\n}\n\n#vfzgxuxaof .gt_font_italic {\n  font-style: italic;\n}\n\n#vfzgxuxaof .gt_super {\n  font-size: 65%;\n}\n\n#vfzgxuxaof .gt_footnote_marks {\n  font-size: 75%;\n  vertical-align: 0.4em;\n  position: initial;\n}\n\n#vfzgxuxaof .gt_asterisk {\n  font-size: 100%;\n  vertical-align: 0;\n}\n\n#vfzgxuxaof .gt_indent_1 {\n  text-indent: 5px;\n}\n\n#vfzgxuxaof .gt_indent_2 {\n  text-indent: 10px;\n}\n\n#vfzgxuxaof .gt_indent_3 {\n  text-indent: 15px;\n}\n\n#vfzgxuxaof .gt_indent_4 {\n  text-indent: 20px;\n}\n\n#vfzgxuxaof .gt_indent_5 {\n  text-indent: 25px;\n}\n</style>\n<table class=\"gt_table\" data-quarto-disable-processing=\"false\" data-quarto-bootstrap=\"false\">\n  <thead>\n    <tr class=\"gt_col_headings\">\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_left\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"wflow_id\">wflow_id</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_left\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\".config\">.config</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_left\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\".metric\">.metric</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"mean\">mean</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"std_err\">std_err</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"n\">n</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_left\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"preprocessor\">preprocessor</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_left\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"model\">model</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"rank\">rank</th>\n    </tr>\n  </thead>\n  <tbody class=\"gt_table_body\">\n    <tr><td headers=\"wflow_id\" class=\"gt_row gt_left\">recipe_lightgbm</td>\n<td headers=\".config\" class=\"gt_row gt_left\">Preprocessor1_Model11</td>\n<td headers=\".metric\" class=\"gt_row gt_left\">accuracy</td>\n<td headers=\"mean\" class=\"gt_row gt_right\">0.7301587</td>\n<td headers=\"std_err\" class=\"gt_row gt_right\">NA</td>\n<td headers=\"n\" class=\"gt_row gt_right\">1</td>\n<td headers=\"preprocessor\" class=\"gt_row gt_left\">recipe</td>\n<td headers=\"model\" class=\"gt_row gt_left\">boost_tree</td>\n<td headers=\"rank\" class=\"gt_row gt_right\">1</td></tr>\n    <tr><td headers=\"wflow_id\" class=\"gt_row gt_left\">recipe_lightgbm</td>\n<td headers=\".config\" class=\"gt_row gt_left\">Preprocessor1_Model11</td>\n<td headers=\".metric\" class=\"gt_row gt_left\">roc_auc</td>\n<td headers=\"mean\" class=\"gt_row gt_right\">0.8858093</td>\n<td headers=\"std_err\" class=\"gt_row gt_right\">NA</td>\n<td headers=\"n\" class=\"gt_row gt_right\">1</td>\n<td headers=\"preprocessor\" class=\"gt_row gt_left\">recipe</td>\n<td headers=\"model\" class=\"gt_row gt_left\">boost_tree</td>\n<td headers=\"rank\" class=\"gt_row gt_right\">1</td></tr>\n    <tr><td headers=\"wflow_id\" class=\"gt_row gt_left\">recipe_xgb</td>\n<td headers=\".config\" class=\"gt_row gt_left\">Preprocessor1_Model09</td>\n<td headers=\".metric\" class=\"gt_row gt_left\">accuracy</td>\n<td headers=\"mean\" class=\"gt_row gt_right\">0.7704813</td>\n<td headers=\"std_err\" class=\"gt_row gt_right\">0.01220734</td>\n<td headers=\"n\" class=\"gt_row gt_right\">10</td>\n<td headers=\"preprocessor\" class=\"gt_row gt_left\">recipe</td>\n<td headers=\"model\" class=\"gt_row gt_left\">boost_tree</td>\n<td headers=\"rank\" class=\"gt_row gt_right\">2</td></tr>\n    <tr><td headers=\"wflow_id\" class=\"gt_row gt_left\">recipe_xgb</td>\n<td headers=\".config\" class=\"gt_row gt_left\">Preprocessor1_Model09</td>\n<td headers=\".metric\" class=\"gt_row gt_left\">roc_auc</td>\n<td headers=\"mean\" class=\"gt_row gt_right\">0.8316034</td>\n<td headers=\"std_err\" class=\"gt_row gt_right\">0.01125249</td>\n<td headers=\"n\" class=\"gt_row gt_right\">10</td>\n<td headers=\"preprocessor\" class=\"gt_row gt_left\">recipe</td>\n<td headers=\"model\" class=\"gt_row gt_left\">boost_tree</td>\n<td headers=\"rank\" class=\"gt_row gt_right\">2</td></tr>\n    <tr><td headers=\"wflow_id\" class=\"gt_row gt_left\">recipe_tree</td>\n<td headers=\".config\" class=\"gt_row gt_left\">Preprocessor1_Model20</td>\n<td headers=\".metric\" class=\"gt_row gt_left\">accuracy</td>\n<td headers=\"mean\" class=\"gt_row gt_right\">0.7721710</td>\n<td headers=\"std_err\" class=\"gt_row gt_right\">0.01523136</td>\n<td headers=\"n\" class=\"gt_row gt_right\">10</td>\n<td headers=\"preprocessor\" class=\"gt_row gt_left\">recipe</td>\n<td headers=\"model\" class=\"gt_row gt_left\">decision_tree</td>\n<td headers=\"rank\" class=\"gt_row gt_right\">3</td></tr>\n    <tr><td headers=\"wflow_id\" class=\"gt_row gt_left\">recipe_tree</td>\n<td headers=\".config\" class=\"gt_row gt_left\">Preprocessor1_Model20</td>\n<td headers=\".metric\" class=\"gt_row gt_left\">roc_auc</td>\n<td headers=\"mean\" class=\"gt_row gt_right\">0.8284261</td>\n<td headers=\"std_err\" class=\"gt_row gt_right\">0.01503274</td>\n<td headers=\"n\" class=\"gt_row gt_right\">10</td>\n<td headers=\"preprocessor\" class=\"gt_row gt_left\">recipe</td>\n<td headers=\"model\" class=\"gt_row gt_left\">decision_tree</td>\n<td headers=\"rank\" class=\"gt_row gt_right\">3</td></tr>\n    <tr><td headers=\"wflow_id\" class=\"gt_row gt_left\">recipe_knn</td>\n<td headers=\".config\" class=\"gt_row gt_left\">Preprocessor1_Model1</td>\n<td headers=\".metric\" class=\"gt_row gt_left\">accuracy</td>\n<td headers=\"mean\" class=\"gt_row gt_right\">0.7063236</td>\n<td headers=\"std_err\" class=\"gt_row gt_right\">0.01911126</td>\n<td headers=\"n\" class=\"gt_row gt_right\">10</td>\n<td headers=\"preprocessor\" class=\"gt_row gt_left\">recipe</td>\n<td headers=\"model\" class=\"gt_row gt_left\">nearest_neighbor</td>\n<td headers=\"rank\" class=\"gt_row gt_right\">4</td></tr>\n    <tr><td headers=\"wflow_id\" class=\"gt_row gt_left\">recipe_knn</td>\n<td headers=\".config\" class=\"gt_row gt_left\">Preprocessor1_Model1</td>\n<td headers=\".metric\" class=\"gt_row gt_left\">roc_auc</td>\n<td headers=\"mean\" class=\"gt_row gt_right\">0.7420401</td>\n<td headers=\"std_err\" class=\"gt_row gt_right\">0.01885929</td>\n<td headers=\"n\" class=\"gt_row gt_right\">10</td>\n<td headers=\"preprocessor\" class=\"gt_row gt_left\">recipe</td>\n<td headers=\"model\" class=\"gt_row gt_left\">nearest_neighbor</td>\n<td headers=\"rank\" class=\"gt_row gt_right\">4</td></tr>\n    <tr><td headers=\"wflow_id\" class=\"gt_row gt_left\">recipe_glm</td>\n<td headers=\".config\" class=\"gt_row gt_left\">Preprocessor1_Model1</td>\n<td headers=\".metric\" class=\"gt_row gt_left\">accuracy</td>\n<td headers=\"mean\" class=\"gt_row gt_right\">0.7398105</td>\n<td headers=\"std_err\" class=\"gt_row gt_right\">0.01844242</td>\n<td headers=\"n\" class=\"gt_row gt_right\">10</td>\n<td headers=\"preprocessor\" class=\"gt_row gt_left\">recipe</td>\n<td headers=\"model\" class=\"gt_row gt_left\">logistic_reg</td>\n<td headers=\"rank\" class=\"gt_row gt_right\">5</td></tr>\n    <tr><td headers=\"wflow_id\" class=\"gt_row gt_left\">recipe_glm</td>\n<td headers=\".config\" class=\"gt_row gt_left\">Preprocessor1_Model1</td>\n<td headers=\".metric\" class=\"gt_row gt_left\">roc_auc</td>\n<td headers=\"mean\" class=\"gt_row gt_right\">0.7301929</td>\n<td headers=\"std_err\" class=\"gt_row gt_right\">0.03339075</td>\n<td headers=\"n\" class=\"gt_row gt_right\">10</td>\n<td headers=\"preprocessor\" class=\"gt_row gt_left\">recipe</td>\n<td headers=\"model\" class=\"gt_row gt_left\">logistic_reg</td>\n<td headers=\"rank\" class=\"gt_row gt_right\">5</td></tr>\n  </tbody>\n  \n  \n</table>\n</div>\n```\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nmodel_set_res |> autoplot()\n```\n\n::: {.cell-output-display}\n![](Level-6-classification-Tidy-Modeling_files/figure-html/unnamed-chunk-24-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nmodel_set_res |> autoplot( id= 'recipe_xgb')\n```\n\n::: {.cell-output-display}\n![](Level-6-classification-Tidy-Modeling_files/figure-html/unnamed-chunk-25-1.png){width=672}\n:::\n:::\n\n\nselect best model:logistic glm model \n\n::: {.cell}\n\n```{.r .cell-code}\nbest_model_id <- \"recipe_xgb\"\n```\n:::\n\n\nselect best parameters\n\n::: {.cell}\n\n```{.r .cell-code}\nbest_fit <-\n  model_set_res |>\n  extract_workflow_set_result(best_model_id) |>\n  select_best(metric = \"accuracy\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# create workflow for best model\nfinal_workflow <-\n  model_set_res |>\n  extract_workflow(best_model_id) |>\n  finalize_workflow(best_fit)\n```\n:::\n\n\n\n\n\n\n## last fit\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfinal_fit <-\n  final_workflow |>\n  last_fit(data_split)\n```\n:::\n\n\n\n# model result\n\n## Evaluate\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfinal_fit %>%\n  collect_metrics()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 2 × 4\n  .metric  .estimator .estimate .config             \n  <chr>    <chr>          <dbl> <chr>               \n1 accuracy binary         0.827 Preprocessor1_Model1\n2 roc_auc  binary         0.915 Preprocessor1_Model1\n```\n\n\n:::\n:::\n\nAccuracy = (TN + TP)/(TN+TP+FN+FP) = (Number of correct assessments)/Number of all assessments)\n\nSensitivity = TP/(TP + FN) = (Number of true positive assessment)/(Number of all positive assessment)\n\nSpecificity = TN/(TN + FP) = (Number of true negative assessment)/(Number of all negative assessment)\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nall_metrics <- metric_set(accuracy, recall, precision, f_meas, kap, sens, spec)\n\na=final_fit %>% collect_predictions()\n\nall_metrics(a, truth = target_variable,estimate = .pred_class)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 7 × 3\n  .metric   .estimator .estimate\n  <chr>     <chr>          <dbl>\n1 accuracy  binary         0.827\n2 recall    binary         0.982\n3 precision binary         0.793\n4 f_meas    binary         0.877\n5 kap       binary         0.593\n6 sens      binary         0.982\n7 spec      binary         0.561\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nfinal_fit %>%\n  collect_predictions() %>% rename(.pred_T = 2, .pred_F = 3) %>% \n  roc_curve(target_variable, .pred_T) %>% \n  autoplot()\n```\n\n::: {.cell-output-display}\n![](Level-6-classification-Tidy-Modeling_files/figure-html/unnamed-chunk-32-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nfinal_tree <- extract_workflow(final_fit)\nfinal_tree\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n══ Workflow [trained] ══════════════════════════════════════════════════════════\nPreprocessor: Recipe\nModel: boost_tree()\n\n── Preprocessor ────────────────────────────────────────────────────────────────\n5 Recipe Steps\n\n• step_impute_knn()\n• step_rm()\n• step_dummy()\n• step_zv()\n• step_normalize()\n\n── Model ───────────────────────────────────────────────────────────────────────\n##### xgb.Booster\nraw: 14.8 Kb \ncall:\n  xgboost::xgb.train(params = list(eta = 0.080098505877286, max_depth = 12L, \n    gamma = 5.39858008778608e-07, colsample_bytree = 1, colsample_bynode = 0.645669291338583, \n    min_child_weight = 9L, subsample = 0.771166819442296), data = x$data, \n    nrounds = 10, watchlist = x$watchlist, verbose = 0, nthread = 1, \n    objective = \"binary:logistic\")\nparams (as set within xgb.train):\n  eta = \"0.080098505877286\", max_depth = \"12\", gamma = \"5.39858008778608e-07\", colsample_bytree = \"1\", colsample_bynode = \"0.645669291338583\", min_child_weight = \"9\", subsample = \"0.771166819442296\", nthread = \"1\", objective = \"binary:logistic\", validate_parameters = \"TRUE\"\nxgb.attributes:\n  niter\ncallbacks:\n  cb.evaluation.log()\n# of features: 127 \nniter: 10\nnfeatures : 127 \nevaluation_log:\n     iter training_logloss\n    <num>            <num>\n        1        0.6633661\n        2        0.6379807\n---                       \n        9        0.5294025\n       10        0.5201621\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(vip)\n\nfinal_tree %>% \n  extract_fit_parsnip() %>% \n  vip()\n```\n\n::: {.cell-output-display}\n![](Level-6-classification-Tidy-Modeling_files/figure-html/unnamed-chunk-34-1.png){width=672}\n:::\n:::\n\n\n\n\n## save model\n\ncheck model size\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(lobstr)\nobj_size(final_tree)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n1.04 MB\n```\n\n\n:::\n:::\n\n\nbundle and save model\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(bundle)\nmodel_bundle <- bundle(final_tree)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nsaveRDS(model_bundle,'level 6 classification decision tree hotel model.RDS')\n```\n:::\n\n\n## make predication\n\nload model and unbundle\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmodel=readRDS('level 6 classification decision tree hotel model.RDS')\n\nmodel <- unbundle(model)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nfinal_prediction=predict(model,data_valid)\n\nhead(final_prediction)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 6 × 1\n  .pred_class\n  <fct>      \n1 0          \n2 0          \n3 1          \n4 0          \n5 0          \n6 0          \n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nfinal_prediction_data=cbind(data_valid,final_prediction)\n\nconf_mat(final_prediction_data, truth = target_variable,\n    estimate = .pred_class)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n          Truth\nPrediction  0  1\n         0 53 14\n         1  4 18\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\naccuracy(final_prediction_data, truth = target_variable, estimate = .pred_class)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 1 × 3\n  .metric  .estimator .estimate\n  <chr>    <chr>          <dbl>\n1 accuracy binary         0.798\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nfinal_prediction_data %>% group_by(target_variable)%>% count()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 2 × 2\n# Groups:   target_variable [2]\n  target_variable     n\n  <fct>           <int>\n1 0                  57\n2 1                  32\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nfinal_prediction_data %>% group_by(.pred_class) %>% count()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 2 × 2\n# Groups:   .pred_class [2]\n  .pred_class     n\n  <fct>       <int>\n1 0              67\n2 1              22\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nconf_mat(final_prediction_data, truth = target_variable,\n    estimate = .pred_class)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n          Truth\nPrediction  0  1\n         0 53 14\n         1  4 18\n```\n\n\n:::\n:::\n\n\n# reference:\n\n\nhttps://www.tmwr.org\n\nhttps://www.youtube.com/watch?v=IzjmuGJgwKQ\n\nhttps://www.youtube.com/watch?v=_e0NFIaHY2c\n\n\n",
    "supporting": [
      "Level-6-classification-Tidy-Modeling_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}