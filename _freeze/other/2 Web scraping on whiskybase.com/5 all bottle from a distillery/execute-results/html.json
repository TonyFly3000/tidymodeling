{
  "hash": "85c73f4ddbb2e894c07e8134e1963429",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"All bottle from a distillery review\"\nsubtitle: \"with whiskybase.com data\"\nauthor: \"Tony Duan\"\n\nexecute:\n  warning: false\n  error: false\n  eval: false\nformat:\n  html:\n    toc: true\n    toc-location: right\n    code-fold: show\n    code-tools: true\n    number-sections: true\n    code-block-bg: true\n    code-block-border-left: \"#31BAE9\"\n---\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(rvest)\nlibrary(stringr)\nlibrary(openxlsx)\nlibrary(readxl)\nlibrary(janitor)\nlibrary(writexl)\n```\n:::\n\n\n::: {.cell}\n\n```{.r .cell-code}\nurl='https://www.whiskybase.com/whiskies/distillery/257/kawasaki'\npage=read_html(url)\nelement=page %>% \n  html_nodes(\"*\") %>% \n  html_attr(\"class\") %>% \n  unique()\n```\n:::\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata=page%>% html_nodes(\"table\")%>%html_table(fill = TRUE) %>% as.data.frame() %>% clean_names()\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nbottle_link= page%>%html_nodes(\".clickable\")%>% html_attr('href')\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nnames(data)\n```\n:::\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata2=data %>% mutate(var_2=str_trim(var_2),l=ifelse(var_2=='',1,0)) %>% filter(l==1) %>% mutate(bottle_link=bottle_link) %>% select(name,stated_age,strength,bottled,casknumber,rating,bottle_link)\n```\n:::\n\noutput\n\n::: {.cell}\n\n```{.r .cell-code}\nwrite.xlsx(data2,'./output/all bottler under one distillery.xlsx')\n```\n:::\n\n\n# add detail\n\n::: {.cell}\n\n```{.r .cell-code}\ndata002=read_excel('./output/all bottler under one distillery.xlsx')\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nrating_people_num_list=c()\navg_price_list=c()\nlowest_price_list=c()\ncask_type_list=c() \npic_link_list=c()\nwb_id=c()\nstart_time=now()\ncask_number_list=c()\nnumber_of_bottle_list=c()\nscore_list=c()\nbottler_list=c()\nbottle_list=c()\nstrength_list=c()\nbottle_link_list=c()\norder_num=0\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfor (i in data002$bottle_link){\n    Sys.sleep(runif(n=1, min=0.1, max=0.5))\n    order_num=order_num+1\n    tryCatch({\n    \n    print(paste('#############',order_num,'bottle ######################################## '))\n    print(i)\n    url=i\n    page = read_html(url)\n  }, error=function(e){cat(\"ERROR :\",conditionMessage(e), \"\\n\")})\n    #################### bottle_link_list\n    \n    bottle_link_list=c(bottle_link_list,i)\n      \n    ###################### score\n    bottle=(page%>% html_nodes('h1')%>% html_text())[1]\n    bottle=bottle %>% str_remove_all('\\n') %>% str_remove_all('\\t')\n    print(paste0(\"bottle: \",(bottle)[1]))\n    bottle_list=c(bottle_list,bottle)\n    \n    \n    ###################### score\n    score=(page%>% html_nodes('.votes-rating-current')%>% html_text())[1]\n    print(paste0(\"score: \",score))\n    score_list=c(score_list,score)\n    \n    ####################### rating_people_num\n    rating_people_num=page%>% html_nodes('.votes-count')%>% html_text()\n    print(rating_people_num)[1]\n    rating_people_num_list=c(rating_people_num_list,rating_people_num[1])\n    \n    \n    ##################### lowest price\n    lowest_price=page%>% html_nodes('.wb--shop-links-panel--price')%>% html_text()\n    lowest_price2=if(identical(lowest_price, character(0))==TRUE){0}else{lowest_price}\n    print(lowest_price2)\n    lowest_price_list=c(lowest_price_list,lowest_price2)\n    \n    ############################# average price\n    avg_price=page%>% html_nodes('p+ p')%>% html_text()\n    avg_price6=case_when(str_detect(avg_price, \"[0-9]\")==TRUE~avg_price,.default='')\n    print(paste('price is :',avg_price6[1]))\n    avg_price_list=c(avg_price_list,avg_price6[1])\n    \n    ################################## cask type\n    bottle_name=page%>% html_nodes('#whisky-details dt')%>% html_text()\n    bottle_value=page%>% html_nodes('#whisky-details dt+ dd')%>% html_text()\n    bottle_name_value=data.frame(bottle_name,bottle_value)\n    cask=bottle_name_value%>% filter(bottle_name=='Cask Type') %>% select(bottle_value)\n    cask2=if(nrow(cask)==0){'unknow cask'}else{ unname(unlist(cask[1,]))}\n    print(cask2)\n    cask_type_list=c(cask_type_list,cask2)\n    \n    ################################## Bottler\n    #bottle_name=page%>% html_nodes('#whisky-details dt')%>% html_text()\n    #bottle_value=page%>% html_nodes('#whisky-details dt+ dd')%>% html_text()\n    #bottle_name_value=data.frame(bottle_name,bottle_value)\n    bottler=bottle_name_value%>% filter(bottle_name=='Bottler') %>% select(bottle_value)\n    bottler=if(nrow(bottler)==0){'unknow Bottler'}else{ unname(unlist(bottler[1,]))}\n    print(bottler)\n    bottler_list=c(bottler_list,bottler)\n    \n    ################################## strength\n    #bottle_name=page%>% html_nodes('#whisky-details dt')%>% html_text()\n    #bottle_value=page%>% html_nodes('#whisky-details dt+ dd')%>% html_text()\n    #bottle_name_value=data.frame(bottle_name,bottle_value)\n    strength=bottle_name_value%>% filter(bottle_name=='Strength') %>% select(bottle_value)\n    strength=if(nrow(strength)==0){'unknow strength'}else{ unname(unlist(strength[1,]))}\n    print(strength)\n    strength_list=c(strength_list,strength)\n    \n    \n      \n    ##################### number_of_bottle \n    number_of_bottle1=bottle_name_value%>% filter(bottle_name=='Number of bottles') %>% select(bottle_value)\n    number_of_bottle2=if(nrow(number_of_bottle1)==0){'unknow Number of bottles'}else{ unname(unlist(number_of_bottle1[1,]))}\n      \n    print(number_of_bottle2)\n    number_of_bottle_list=c(number_of_bottle_list,number_of_bottle2)\n      \n    ##################### Casknumber \n    cask_number1=bottle_name_value%>% filter(bottle_name=='Casknumber') %>% select(bottle_value)\n    cask_number2=if(nrow(cask_number1)==0){'unknow Casknumber'}else{ unname(unlist(cask_number1[1,]))}\n      \n    print(paste('casknumber:',cask_number2))\n    cask_number_list=c(cask_number_list,cask_number2)\n      \n      \n    ########################################### wb id \n    id_name=page%>% html_nodes(' #whisky-details dd:nth-child(2)')%>% html_text()\n    print(id_name)\n    wb_id=c(wb_id,id_name)\n      \n    ####### check \n      \n    id_num=as.numeric(str_replace(id_name,'WB',''))\n    print(id_num)\n      \n    a=(str_split(url,'/')[[1]])\n    b=as.numeric(a[length(a)-1])\n    #print(paste(\"wb id from link\",b))\n    #print(paste(\"wb id from page\",id_num))\n    if(id_num!=b){\n        print(i)\n        print('############## error !!!!!!!!##################')\n        break\n    }\n    ##################     pic link   #######################\n    pic_link=(page%>% html_nodes('.photo')%>% html_attr('href'))[1]\n    pic_link2=if(identical(pic_link, character(0))==TRUE){0}else{pic_link}\n      \n    print(pic_link2)\n    pic_link_list=c(pic_link_list,pic_link2)\n    \n ######### output to excel on every 10 bottle\n  if(order_num%%10==0){\n    data003=cbind((data002[1:order_num,]),bottle_list,score_list,rating_people_num_list,lowest_price_list,avg_price_list,cask_type_list,number_of_bottle_list,bottler_list,strength_list,cask_number_list,wb_id,pic_link_list,bottle_link_list)%>% as_tibble()\n    \n    \n    write_xlsx(data003,'./output/all bottel under one distillery with detail.xlsx')\n  }\n}\n#########################################################  \n```\n:::\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata003=cbind(data002,bottle_list,score_list,rating_people_num_list,lowest_price_list,avg_price_list,cask_type_list,number_of_bottle_list,bottler_list,strength_list,cask_number_list,wb_id,pic_link_list,bottle_link_list) %>% as_tibble()\n\nwrite_xlsx(data003,'./output/all bottel under one distillery with detail.xlsx')\n```\n:::",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}