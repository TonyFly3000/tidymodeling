{
  "hash": "e2e48acd6bacf1ba7ac9abe677a7f2ca",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"on bottle review\"\nsubtitle: \"with whiskybase.com data\"\nauthor: \"Tony Duan\"\n\nexecute:\n  warning: false\n  error: false\n\nformat:\n  html:\n    toc: true\n    toc-location: right\n    code-fold: show\n    code-tools: true\n    number-sections: true\n    code-block-bg: true\n    code-block-border-left: \"#31BAE9\"\n---\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(rvest)\nlibrary(stringr)\nlibrary(openxlsx)\nlibrary(readxl)\n```\n:::\n\n\n::: {.cell}\n\n```{.r .cell-code}\nurl='https://www.whiskybase.com/whiskies/whisky/147142/macallan-12-year-old'\npage=read_html(url)\nelement=page %>% \n  html_nodes(\"*\") %>% \n  html_attr(\"class\") %>% \n  unique()\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntext=page%>% html_nodes(\"*\")%>% html_text2()\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nhead(text)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"document.documentElement.className += 'js' Macallan 12-year-old - Ratings and reviews - Whiskybase {\\\"@context\\\":\\\"https:\\\\/\\\\/schema.org\\\\/\\\",\\\"@type\\\":\\\"Product\\\",\\\"name\\\":\\\"Macallan 12-year-old\\\",\\\"sku\\\":147142,\\\"brand\\\":{\\\"@type\\\":\\\"Brand\\\",\\\"name\\\":\\\"Macallan\\\"},\\\"gtin\\\":\\\"5010314017408\\\",\\\"gtin13\\\":\\\"5010314017408\\\",\\\"image\\\":\\\"https:\\\\/\\\\/static.whiskybase.com\\\\/storage\\\\/whiskies\\\\/1\\\\/4\\\\/7142\\\\/304090-normal.png\\\",\\\"offers\\\":{\\\"@type\\\":\\\"AggregateOffer\\\",\\\"lowPrice\\\":71.159999999999996589394868351519107818603515625,\\\"highPrice\\\":296.6399999999999863575794734060764312744140625,\\\"priceCurrency\\\":\\\"EUR\\\",\\\"offerCount\\\":40},\\\"aggregateRating\\\":{\\\"@type\\\":\\\"AggregateRating\\\",\\\"bestRating\\\":100,\\\"worstRating\\\":0,\\\"ratingValue\\\":84.43000000000000682121026329696178436279296875,\\\"reviewCount\\\":284},\\\"description\\\":\\\"Macallan 12-year-old 12 yr. The strength of this whisky is 40.0 % Vol. A bottle from Macallan\\\"}window.__exc = { e: [], a: function(e) { return window.application ? window.application.exec(e) : __exc.e.push(e) } }\"\n[2] \"\"                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  \n[3] \"\"                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  \n[4] \"document.documentElement.className += 'js'\"                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        \n[5] \"\"                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  \n[6] \"\"                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  \n```\n\n\n:::\n:::\n\n\n::: {.cell}\n\n```{.r .cell-code}\nwrite_delim(tibble(text), \"./data/text.txt\")\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nrating_people_num_list=c()\navg_price_list=c()\nlowest_price_list=c()\ncask_type_list=c() \npic_link_list=c()\nwb_id=c()\nstart_time=now()\ncask_number_list=c()\nnumber_of_bottle_list=c()\nscore_list=c()\nbottler_list=c()\nbottle_list=c()\nstrength_list=c()\n\norder_num=1\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n###################### score\nbottle=(page%>% html_nodes('h1')%>% html_text())[1]\nbottle=bottle %>% str_remove_all('\\n') %>% str_remove_all('\\t')\nprint(paste0(\"bottle: \",(bottle)[1]))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"bottle: Macallan12-year-old\"\n```\n\n\n:::\n\n```{.r .cell-code}\nbottle_list=c(bottle_list,bottle)\n\n\n###################### score\nscore=(page%>% html_nodes('.votes-rating-current')%>% html_text())[1]\nprint(paste0(\"score: \",score))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"score: 84.43\"\n```\n\n\n:::\n\n```{.r .cell-code}\nscore_list=c(score_list,score)\n\n####################### rating_people_num\nrating_people_num=page%>% html_nodes('.votes-count')%>% html_text()\nprint(rating_people_num)[1]\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"284\" \"284\"\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"284\"\n```\n\n\n:::\n\n```{.r .cell-code}\nrating_people_num_list=c(rating_people_num_list,rating_people_num[1])\n\n\n##################### lowest price\nlowest_price=page%>% html_nodes('.wb--shop-links-panel--price')%>% html_text()\nlowest_price2=if(identical(lowest_price, character(0))==TRUE){0}else{lowest_price}\nprint(lowest_price2)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"â‚¬ 79.89\"\n```\n\n\n:::\n\n```{.r .cell-code}\nlowest_price_list=c(lowest_price_list,lowest_price2)\n\n############################# average price\navg_price=page%>% html_nodes('p+ p')%>% html_text()\navg_price6=case_when(str_detect(avg_price, \"[0-9]\")==TRUE~avg_price,.default='')\nprint(paste('price is :',avg_price6[1]))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"price is : \"\n```\n\n\n:::\n\n```{.r .cell-code}\navg_price_list=c(avg_price_list,avg_price6[1])\n\n################################## cask type\nbottle_name=page%>% html_nodes('#whisky-details dt')%>% html_text()\nbottle_value=page%>% html_nodes('#whisky-details dt+ dd')%>% html_text()\nbottle_name_value=data.frame(bottle_name,bottle_value)\ncask=bottle_name_value%>% filter(bottle_name=='Cask Type') %>% select(bottle_value)\ncask2=if(nrow(cask)==0){'unknow cask'}else{ unname(unlist(cask[1,]))}\nprint(cask2)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"Sherry Seasoned Oak casks from Jerez\"\n```\n\n\n:::\n\n```{.r .cell-code}\ncask_type_list=c(cask_type_list,cask2)\n\n################################## Bottler\n#bottle_name=page%>% html_nodes('#whisky-details dt')%>% html_text()\n#bottle_value=page%>% html_nodes('#whisky-details dt+ dd')%>% html_text()\n#bottle_name_value=data.frame(bottle_name,bottle_value)\nbottler=bottle_name_value%>% filter(bottle_name=='Bottler') %>% select(bottle_value)\nbottler=if(nrow(bottler)==0){'unknow Bottler'}else{ unname(unlist(bottler[1,]))}\nprint(bottler)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"Distillery Bottling\"\n```\n\n\n:::\n\n```{.r .cell-code}\nbottler_list=c(bottler_list,bottler)\n\n################################## strength\n#bottle_name=page%>% html_nodes('#whisky-details dt')%>% html_text()\n#bottle_value=page%>% html_nodes('#whisky-details dt+ dd')%>% html_text()\n#bottle_name_value=data.frame(bottle_name,bottle_value)\nstrength=bottle_name_value%>% filter(bottle_name=='Strength') %>% select(bottle_value)\nstrength=if(nrow(strength)==0){'unknow strength'}else{ unname(unlist(strength[1,]))}\nprint(strength)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"40.0 % Vol.\"\n```\n\n\n:::\n\n```{.r .cell-code}\nstrength_list=c(strength_list,strength)\n\n\n  \n##################### number_of_bottle \nnumber_of_bottle1=bottle_name_value%>% filter(bottle_name=='Number of bottles') %>% select(bottle_value)\nnumber_of_bottle2=if(nrow(number_of_bottle1)==0){'unknow Number of bottles'}else{ unname(unlist(number_of_bottle1[1,]))}\n  \nprint(number_of_bottle2)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"unknow Number of bottles\"\n```\n\n\n:::\n\n```{.r .cell-code}\nnumber_of_bottle_list=c(number_of_bottle_list,number_of_bottle2)\n  \n##################### Casknumber \ncask_number1=bottle_name_value%>% filter(bottle_name=='Casknumber') %>% select(bottle_value)\ncask_number2=if(nrow(cask_number1)==0){'unknow Casknumber'}else{ unname(unlist(cask_number1[1,]))}\n  \nprint(paste('casknumber:',cask_number2))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"casknumber: unknow Casknumber\"\n```\n\n\n:::\n\n```{.r .cell-code}\ncask_number_list=c(cask_number_list,cask_number2)\n  \n  \n########################################### wb id \nid_name=page%>% html_nodes(' #whisky-details dd:nth-child(2)')%>% html_text()\nprint(id_name)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"WB147142\"\n```\n\n\n:::\n\n```{.r .cell-code}\nwb_id=c(wb_id,id_name)\n  \n####### check \n  \nid_num=as.numeric(str_replace(id_name,'WB',''))\nprint(id_num)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 147142\n```\n\n\n:::\n\n```{.r .cell-code}\na=(str_split(url,'/')[[1]])\nb=as.numeric(a[length(a)-1])\nprint(paste(\"wb id from link\",b))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"wb id from link 147142\"\n```\n\n\n:::\n\n```{.r .cell-code}\nprint(paste(\"wb id from page\",id_num))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"wb id from page 147142\"\n```\n\n\n:::\n\n```{.r .cell-code}\nif(id_num!=b){\n    print(i)\n    print('############## error !!!!!!!!##################')\n    break\n}\n##################     pic link   #######################\npic_link=(page%>% html_nodes('.photo')%>% html_attr('href'))[1]\npic_link2=if(identical(pic_link, character(0))==TRUE){0}else{pic_link}\n  \nprint(pic_link2)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"https://static.whiskybase.com/storage/whiskies/1/4/7142/304090-big.jpg\"\n```\n\n\n:::\n\n```{.r .cell-code}\npic_link_list=c(pic_link_list,pic_link2)\n#########################################################  \n```\n:::\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata=cbind(bottle_list,score_list,rating_people_num_list,lowest_price_list,avg_price_list,cask_type_list,number_of_bottle_list,bottler_list,strength_list,cask_number_list,wb_id,pic_link_list,url) %>% as_tibble()\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nglimpse(data)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRows: 1\nColumns: 13\n$ bottle_list            <chr> \"Macallan12-year-old\"\n$ score_list             <chr> \"84.43\"\n$ rating_people_num_list <chr> \"284\"\n$ lowest_price_list      <chr> \"â‚¬ 79.89\"\n$ avg_price_list         <chr> \"\"\n$ cask_type_list         <chr> \"Sherry Seasoned Oak casks from Jerez\"\n$ number_of_bottle_list  <chr> \"unknow Number of bottles\"\n$ bottler_list           <chr> \"Distillery Bottling\"\n$ strength_list          <chr> \"40.0 % Vol.\"\n$ cask_number_list       <chr> \"unknow Casknumber\"\n$ wb_id                  <chr> \"WB147142\"\n$ pic_link_list          <chr> \"https://static.whiskybase.com/storage/whiskiesâ€¦\n$ url                    <chr> \"https://www.whiskybase.com/whiskies/whisky/147â€¦\n```\n\n\n:::\n:::\n# output\n\n::: {.cell}\n\n```{.r .cell-code}\nwrite.xlsx(data,'./output/one_page_review.xlsx')\n```\n:::\n\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}