{
  "hash": "08ce45a9bde1d92515677531fce9359a",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Web scraping with rvest\"\nauthor: \"Tony Duan\"\n\nexecute:\n  warning: false\n  error: false\n  eval: false\nformat:\n  html:\n    toc: true\n    toc-location: right\n    code-fold: show\n    code-tools: true\n    number-sections: true\n    code-block-bg: true\n    code-block-border-left: \"#31BAE9\"\n---\n\n\nrvest helps you scrape (or harvest) data from web pages. It is designed to work with magrittr to make it easy to express common web scraping tasks, inspired by libraries like beautiful soup and RoboBrowser.\n\nIf you’re scraping multiple pages, I highly recommend using rvest in concert with polite. The polite package ensures that you’re respecting the robots.txt and not hammering the site with too many requests.\n\n![](images/clipboard-1520421631.png){width=\"500\"}\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(rvest)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\npackageVersion(\"rvest\")\n```\n:::\n\n\nWeb scraping on www.whiskynotes.be\n\n# year page\n\n\n::: {.cell}\n\n```{.r .cell-code}\nyear_ur='https://www.whiskynotes.be/2023'\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nyear_page <- read_html(year_ur)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nbottle001 <- year_page %>% html_elements(\"p\")%>% html_text2()\nbottle001\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nlength(bottle001)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ntipic001 <- year_page %>% html_elements(\"h2\") %>% html_text2()\ntipic001\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nlength(tipic001)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ntopic_link_list <- year_page %>%\n  html_elements(css = \".entry-permalink\")%>% html_attr(\"href\")\n\ntopic_link_list\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nlength(topic_link_list)\n```\n:::\n\n\n# review page\n\n\n::: {.cell}\n\n```{.r .cell-code}\nreview_url='https://www.whiskynotes.be/2024/rum/9-rum-reviews-diamond-don-jose-tdl-fiji-enmore/'\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nreview_page <- read_html(review_url)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nbottle_name=review_page  %>% html_elements(\".product-main__name\") %>% html_text2()\nbottle_name\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nbottle_review=review_page  %>% html_elements(\"p\") %>% html_text2()\nbottle_review\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nbottle_review_Nose=bottle_review[bottle_review %>% str_detect('Nose:')]\nbottle_review_Nose\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nbottle_review_Mouth=bottle_review[bottle_review %>% str_detect('Mouth:')]\nbottle_review_Mouth\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nbottle_review_Finish=bottle_review[bottle_review %>% str_detect('Finish:')]\nbottle_review_Finish\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nfirst_bottle_score=review_page  %>% html_elements(\".entry-score\") %>% html_text2()\nfirst_bottle_score=first_bottle_score %>% str_match('[0-9][0-9]') %>% as.data.frame() %>% filter(is.na(V1)==FALSE)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nbottle_score=review_page  %>% html_elements(\".entry-score , strong\") %>% html_text2()\nbottle_score=bottle_score %>% str_match('[0-9][0-9]') %>% as.data.frame() %>% filter(is.na(V1)==FALSE)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# move the last one to the first one\nall_page_score=rbind(tail(bottle_score,1),head(bottle_score,-1))\nall_page_score\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\npage_published_date=review_page  %>% html_elements(\".published\") %>% html_text2()\npage_published_date\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\npage_class=review_page  %>% html_elements(\".cat-links a\") %>% html_text2()\npage_class\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\npage_title=review_page  %>% html_elements(\".entry-title\") %>% html_text2()\npage_title\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\none_page_review=data_frame(bottle_name,bottle_review_Nose,bottle_review_Mouth,bottle_review_Finish,all_page_score,page_class,page_published_date,page_title,review_url) %>% rename(socre=V1)\none_page_review\n```\n:::\n\n\n# output\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(openxlsx)\nwrite.xlsx(one_page_review,'whisky_note_review.xlsx')\n```\n:::\n\n\n# loop\n\n\n::: {.cell}\n\n```{.r .cell-code}\nyear_list=seq(2010,2024)\nyear_list\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nurl_list=paste0('https://www.whiskynotes.be/',year_list)\nurl_list\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nbottle_list=c()\ntopic_list=c()\ntopic_link_list=c()\n\n\nfor (i in url_list){\n  print(i)\n  year_ur=i\n  year_page <- read_html(year_ur)\n  bottle001 <- year_page %>% html_elements(\"p\")%>% html_text2()\n  topic001 <- year_page %>% html_elements(\"h2\") %>% html_text2()\n  topic_link_001 <- year_page %>%\n    html_elements(css = \".entry-permalink\")%>% html_attr(\"href\")\n  \n  bottle_list=c(bottle_list,bottle001)\n  topic_list=c(topic_list,topic001)\n  topic_link_list=c(topic_link_list,topic_link_001)\n  Sys.sleep(1)\n  }\n```\n:::\n\n\n# combine\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntotal_topic_link=as.data.frame(topic_link_list)\n```\n:::\n\n\n# output\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(openxlsx)\nwrite.xlsx(total_topic_link,'total_topic_link.xlsx')\n```\n:::\n\n\n## one page function\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\none_page_function <- function(review_url){\n  \n\n  \n     #review_url=\"https://www.whiskynotes.be/2023/linkwood/linkwood-2008-benrinnes-2000-glentauchers-2009-maltbarn/\"\n  \n  \n    tryCatch({\n\n    print(review_url)\n    review_page <- read_html(review_url)\n    closeAllConnections()\n  }, error=function(e){cat(\"ERROR :\",conditionMessage(e), \"\\n\")})\n  \n\n  page_class=review_page  %>% html_elements(\".cat-links a\") %>% html_text2()\n  page_class=str_flatten(page_class,collapse = \"-\")\n  \n  bottle_name=review_page  %>% html_elements(\".entry-content h2\") %>% html_text2()\n  bottle_name=bottle_name[nzchar(bottle_name)]\n  \n  # remove ? mark non bottle name element\n  bottle_name=bottle_name[!bottle_name%>% str_detect(\"\\\\?\")]\n  # remove Drams Delivered revisited  non bottle name element\n  bottle_name=bottle_name[ !bottle_name == 'Drams Delivered revisited']\n  print(bottle_name) \n  \n  bottle_review_raw=review_page  %>% html_elements(\"p\") %>% html_text()\n  bottle_review=unlist(strsplit(bottle_review_raw,\"(?= Nose: )\",perl = TRUE))\n  bottle_review=unlist(strsplit(bottle_review,\"(?= Mouth: )\",perl = TRUE))\n   bottle_review=unlist(strsplit(bottle_review,\"(?= Finish: )\",perl = TRUE))\n  \n  bottle_review_Nose=bottle_review[bottle_review %>% str_detect('Nose:')]\n  bottle_review_Nose=bottle_review_Nose[nzchar(bottle_review_Nose)]\n\n  bottle_review_Mouth=bottle_review[bottle_review %>% str_detect('Mouth:')]\n  bottle_review_Mouth=bottle_review_Mouth[nzchar(bottle_review_Mouth)]\n\n  bottle_review_Finish=bottle_review[bottle_review %>% str_detect('Finish:')]\n  bottle_review_Finish=bottle_review_Finish[nzchar(bottle_review_Finish)]\n  \n  ########### add dummy score if there is no score review #########\n  # bottle_review_Finish_score=bottle_review[bottle_review %>% str_detect('Finish:|Score:')][-1]\n \n  # # bottle_review_Finish_score2=bottle_review_Finish_score\n  \n  \n  # order=1\n  # for (word in bottle_review_Finish_score){\n  #   print(word)\n  #   print(order)\n  #   print(order%%2)\n  #   print(word %>% str_detect('Score:'))\n  #   print(order%%2==0 & word %>% str_detect('Score:')==FALSE)\n  #   if (order%%2==0 & word %>% str_detect('Score:')==FALSE){\n  #     print('adding add dummy score if there is no score review ')\n  #     bottle_review_Finish_score2=append(bottle_review_Finish_score2,'Score:00/100',order-1)\n  #   }else{\n  #   }\n  #   order=order+1\n  #   }\n################################################\n    \n  \n  \n  first_bottle_score=review_page  %>% html_elements(\".entry-score\") %>% html_text2()\n\n  bottle_score=review_page  %>% html_elements(\"strong\") %>% html_text2()\n  \n  bottle_score2=bottle_score %>% str_match('[0-9][0-9]/100') %>% as.data.frame() %>% filter(is.na(V1)==FALSE)\n  bottle_score2=bottle_score2 %>% mutate(V1=str_replace(V1,'/100',''))\n\n\n  if(identical(bottle_score, character(0))==TRUE|nrow(bottle_score2)==0){\n    all_page_score=first_bottle_score %>% tibble()%>% rename(all_page_score='.') \n  }else{\n  #bottle_score=bottle_score %>% str_match('[0-9][0-9]') %>% as.data.frame() %>% filter(is.na(V1)==FALSE)\n  all_page_score=rbind(first_bottle_score,bottle_score2) %>% rename(all_page_score=V1) \n  }\n\n  page_published_date=review_page  %>% html_elements(\".published\") %>% html_text2()\n\n\n  page_title=review_page  %>% html_elements(\".entry-title\") %>% html_text2()\n  \n  if(nrow(all_page_score)!=length(bottle_name)){all_page_score=0}\n  if(length(bottle_review_Nose)!=length(bottle_name)){bottle_review_Nose='no comment'}\n  if(length(bottle_review_Mouth)!=length(bottle_name)){bottle_review_Mouth='no comment'}\n  if(length(bottle_review_Finish)!=length(bottle_name)){bottle_review_Finish='no comment'}\n  \n  \n  \n  one_page_review=tibble(bottle_name,bottle_review_Nose,bottle_review_Mouth,bottle_review_Finish,all_page_score,page_class,page_published_date,page_title,review_url) \n  \n\n  Sys.sleep(runif(n=1, min=0.1, max=0.8))\n  #print(one_page_review)\n  print(dim(one_page_review))\n  #remove(review_page)\n  return(one_page_review)\n}\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nlength(topic_link_list)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nnews=topic_link_list %>% str_detect('/whisky-news/')\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ntopic_link_list_exclude_news=topic_link_list[!news]\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nlength(topic_link_list_exclude_news)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n#topic_link_list_exclude_news\n\nwhich(topic_link_list_exclude_news==\"https://www.whiskynotes.be/2023/world/paul-john-christmas-edition-2022/\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ntopic_link_list_exclude_news_small=c('https://www.whiskynotes.be/2024/rum/9-rum-reviews-diamond-don-jose-tdl-fiji-enmore/','https://www.whiskynotes.be/2024/benriach/benriach-glenburgie-campbeltown-highland-milroys-soho/','https://www.whiskynotes.be/2024/rum/6-rums-black-tot-uitvlugt-clarendon-tdl-martinique/')\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nall_page_review_list=data.frame()\n\nstart_time=Sys.time()\nprint(paste0(\"Start time: \", start_time))\n\nfor (i in topic_link_list_exclude_news){\n  \n   print(paste0(\"Running loop No.\",which(topic_link_list_exclude_news==i)))\n         \n   print(paste0(\"current time: \", Sys.time()))\n   a=one_page_function(i)\n   all_page_review_list=rbind(all_page_review_list,a)\n   print(paste0(\"Used time: \", Sys.time()-start_time))\n}\n\nend_time=Sys.time()\nprint(paste0(\"End time: \", end_time))\n\nprint(paste0(\"used time: \", end_time-start_time))\n\nlibrary(openxlsx)\nwrite.xlsx(all_page_review_list,'all_page_review_list.xlsx')\n\n\n\nall_page_review_list_final=all_page_review_list %>% filter(all_page_score!=0& bottle_review_Mouth!='no comment')\n\nwrite.xlsx(all_page_review_list_final,'all_page_review_list_final.xlsx')\n```\n:::\n\n\n\n# output\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(openxlsx)\nwrite.xlsx(all_page_review_list,'all_page_review_list.xlsx')\n```\n:::\n\n\n# reference:\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}