{
  "hash": "9517e2117b1b0a6a87ebde13f92a7cff",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"clean up\"\nsubtitle: \"with whiskynote.be data\"\nauthor: \"Tony Duan\"\n\nexecute:\n  warning: false\n  error: false\n  eval: false\nformat:\n  html:\n    toc: true\n    toc-location: right\n    code-fold: show\n    code-tools: true\n    number-sections: true\n    code-block-bg: true\n    code-block-border-left: \"#31BAE9\"\n---\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(rvest)\nlibrary(stringr)\nlibrary(openxlsx)\nlibrary(readxl)\nlibrary(janitor)\nlibrary(writexl)\nlibrary(lubridate)\n```\n:::\n\n# input data\n::: {.cell}\n\n```{.r .cell-code}\ndata001=read_excel('./output/all_page_bottle_list_all.xlsx')\n```\n:::\n\n# clean data\n::: {.cell}\n\n```{.r .cell-code}\ndata002=data001 %>% clean_names()\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nglimpse(data002)\n```\n:::\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata003=data002 %>%  mutate(published_date=dmy(page_published_date)\n                            ,year=year(published_date)\n                            ,score=as.numeric(all_page_score)\n                            ,high_score=if_else(score>=90,1,0)\n                             ,score_group=case_when(\n                                        score >= 90 ~ \"1.>=90\",\n                                        score > 85 ~ \"2. >=85\",\n                                          TRUE ~ \"3. <85\")\n                            ,bottle_name=bottle_name%>% str_replace('allt-à-bhainne','Allt-a-Bhainne')%>% str_replace('Allt-a-Bhaine','Allt-a-Bhainne') %>% str_to_lower()\n                            )%>% filter(score>0\n                                        ,score<=100\n                                        ,!page_class %in% c(\"* Armagnac\",\"* Cognac\",\"* Rum\",\"* Armagnac-* Cognac\",\"* Other spirits\",\"* Distillery visits\",\"\")\n                                        ,bottle_review_nose!='no comment'\n                                        ,bottle_review_mouth!='no comment'\n                                        ,bottle_review_finish!='no comment')%>% arrange(score)\n\n\n\nglimpse(data003)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\np=ggplot(data003, aes(year,score,group=year)) + geom_boxplot()\np\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsummary001=data003 %>% group_by(year) %>% summarise(bottles=n(),avg_score=mean(score),high=sum(high_score)\n                                                 \n                                                 ,high_pct=sum(high_score)/n()\n                                                 )\nsummary001\n```\n:::\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nall_distrillery_from_wb=read_xlsx('data/all distrillery from wb.xlsx') %>% mutate(name=Name %>% str_replace('Isle of Jura','jura')  %>% str_replace('Teeling Whiskey Distillery','Teeling') %>% str_replace('Distillery','')%>% str_replace('(Closed)','') %>% str_replace('St. Magdalene','St Magdalene') %>% str_trim()%>% str_to_lower()\n                                                                              ) \n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nkeywords <- as.character(all_distrillery_from_wb$name)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndata004=data003[grepl(paste(keywords, collapse=\"|\"), data003$bottle_name),]\n```\n:::\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata005=str_extract_all(tolower(data003$bottle_name),paste(keywords,collapse  = \"|\"))\n```\n:::\n\n\n\nkeep first match\n::: {.cell}\n\n```{.r .cell-code}\ndata006=lapply(data005, `[`, 1)\n```\n:::\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata006[lengths(data006)==0] <- NA\ndata007=unlist(data006)\n```\n:::\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata008=data003 %>% mutate(distillery_name=data007)\n```\n:::\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(\"ggthemes\")\nlibrary(\"scales\")\nlibrary(showtext)\nshowtext_auto()\n\ncoeff <- 5\n\np=ggplot(summary001, aes(year,avg_score)) + geom_line(size=2) +\n  geom_col(aes(year,bottles/ coeff), fill = \"blue\")+scale_y_continuous(\"平均分\",limits=c(0,100), sec.axis = sec_axis(~.*coeff, name = \"评分酒款数量\",breaks = seq(0, 500, by = 100)))+labs(caption = \"2010-01 to 2024-04\")+ ggtitle(\"whiskynote.be\")+ xlim(min=2009, 2025)\np+theme_economist()+scale_x_continuous(breaks=pretty_breaks(n = 20))+scale_y_continuous(breaks=pretty_breaks(n = 20))\n```\n:::\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsummary002=data003 %>% group_by(year,score_group) %>% \n  summarise(bottles=n())%>% \n  mutate(score_group=score_group %>% as.factor()) %>% group_by(year) %>% mutate(share=round(bottles/sum(bottles),2))\n\nsummary002\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(\"ggthemes\")\nlibrary(\"scales\")\nlibrary(showtext)\nshowtext_auto()\n\n\np=ggplot(summary002, aes(y=share, x=year,colour=score_group)) + \n    geom_line()\n\np+theme_economist()+scale_x_continuous(breaks=pretty_breaks(n = 20))+scale_y_continuous(breaks=pretty_breaks(n = 10))\n```\n:::\n\n\n# reference:\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}