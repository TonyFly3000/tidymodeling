{
  "hash": "0c27ca1cb881d206be851aacc989be8f",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"All page clean up\"\nsubtitle: \"with whiskyfun.com data\"\nauthor: \"Tony Duan\"\n\nexecute:\n  warning: false\n  error: false\n  eval: false\nformat:\n  html:\n    toc: true\n    toc-location: right\n    code-fold: show\n    code-tools: true\n    number-sections: true\n    code-block-bg: true\n    code-block-border-left: \"#31BAE9\"\n---\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(rvest)\nlibrary(stringr)\nlibrary(openxlsx)\nlibrary(readxl)\nlibrary(lubridate)\nlibrary(ggplot2)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\npackageVersion(\"rvest\")\n```\n:::\n\n\n# input\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata001=read_excel('./output/all_page_review_all_v2.xlsx')\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nglimpse(data001)\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata002=data001%>% mutate(\n  \n  bottle_review2=bottle_review2%>% str_replace(\"â€“\", \"-\")%>% str_replace(\"Palate\", \"Mouth\")\n  ,name=paste0(str_extract(bottle_review2, regex( \"[^)]+\")),\")\")\n  ,distillery=bottle_review2 %>% str_extract(\".*?\\\\d\")%>% str_sub(end=-3)\n  \n  ,colour=(bottle_review2 %>% str_match(\"Colour:\\\\s*(.*?)\\\\s*\\\\.\"))[,2]\n  ,nose=(bottle_review2 %>% str_match(\"Nose\\\\s*(.*?)\\\\s*Mouth\"))[,2]\n  ,mouth=(bottle_review2 %>% str_match(\"Mouth\\\\s*(.*?)\\\\s*Finish\"))[,2]\n  ,finish=(bottle_review2 %>% str_match(\"Finish:\\\\s*(.*?)\\\\s*Comments\"))[,2]\n  ,comments=(bottle_review2 %>% str_match(\"Comments:\\\\s*(.*?)\\\\s*SGP\"))[,2]\n  \n  #,full_score=(bottle_review2 %>%str_match_all(\"[:digit:][:digit:][:space:]points.\"))%>% sapply(tail, 1)\n  ,full_score=(bottle_review2 %>%str_match_all(\"[:digit:][:digit:][:space:]points.\"))%>% sapply(tail, 1)\n  ,score=full_score %>% str_replace(\"points.\",\"\") %>% as.numeric()\n  \n  ,review_date=((str_match(old_page %>%str_to_lower(),\"https://www.whiskyfun.com/archive\\\\s*(.*?)\\\\s*-\"))[,2] )%>% str_to_title()\n \n  ,review_date2= myd(review_date, truncated = 1)\n  ,review_date2=if_else(is.na(review_date)==TRUE,today(),review_date2)\n  \n  ,review_year=year(review_date2)\n) %>% unique()\n\nglimpse(data002)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ncols=names(data002)\ntest001=data002 %>%filter(if_any(.cols = cols, .fns = ~is.na(.x)))\nglimpse(test001)\n```\n:::\n\n\n::: {.cell}\n\n```{.r .cell-code}\nwrite.xlsx(data002,'./output/all_page_review_clean_v2.xlsx')\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntest001=data002 %>% filter(bottle_review2 %>% str_sub(1,4)=='Nose'|bottle_review2 %>% str_sub(1,6)=='Colour'|bottle_review2 %>% str_sub(1,5)=='Mouth'|bottle_review2 %>% str_sub(1,6)=='Finish'|bottle_review2 %>% str_sub(1,8)=='Comments')\n```\n:::\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nglimpse(test001)\n```\n:::\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntest002=test001 %>% head()\n```\n:::\n\n\n::: {.cell}\n\n```{.r .cell-code}\nreview_html_elements=\".textegrandfoncegras , .TextenormalNEW, .Textenormal,td > font,div td font\"\n\nbottle_review_up1_list=c()\nbottle_review_up2_list=c()\n\nfor (i in test002$bottle_review2){\n  #print(i)\n  link=(test002 %>% filter(bottle_review2==i))$old_page\n  print(link)\n  page=read_html(curl(link, handle = curl::new_handle(\"useragent\" = \"Mozilla/5.0\")))\n  bottle_review=page  %>% html_elements(review_html_elements) %>% html_text2()\n  \n  bottle_review=unique(bottle_review[bottle_review != \"\"])\n  \n  index_num=match(i,bottle_review)\n  \n  bottle_review_up1=bottle_review[index_num-1]\n  bottle_review_up2=bottle_review[index_num-2]\n  \n  bottle_review_up1_list=c(bottle_review_up1_list,bottle_review_up1)\n  bottle_review_up2_list=c(bottle_review_up2_list,bottle_review_up2)\n}\n```\n:::\n\n\n\n\n\n# reference\n\n%d = Day number of month (5, 17, 28, etc.)\n\n%j = Day number of the year (Julian day 001-366)\n\n%a = Abbreviated weekday (Mon, Tue, Wed, etc.)\n\n%A = Full weekday (Monday, Tuesday, etc.) %w = Weekday number (0-6, Sunday is 0)\n\n%u = Weekday number (1-7, Monday is 1)\n\n%W = Week number (00-53, Monday is week start)\n\n%U = Week number (01-53, Sunday is week start)\n\n%m = Month number (e.g. 01, 02, 03, 04)\n\n%b = Abbreviated month (Jan, Feb, etc.)\n\n%B = Full month (January, February, etc.)\n\n%y = 2-digit year (e.g. 89)\n\n%Y = 4-digit year (e.g. 1989)\n\n%h = hours (24-hr clock)\n\n%m = minutes\n\n%s = seconds %z = offset from GMT\n\n%Z = Time zone (character)\n\n\nhttps://epirhandbook.com/en/working-with-dates.html\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}