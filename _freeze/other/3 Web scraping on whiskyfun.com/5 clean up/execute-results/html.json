{
  "hash": "7f2f786118f117d4390bf61fae42d232",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"All page clean up\"\nsubtitle: \"with whiskyfun.com data\"\nauthor: \"Tony Duan\"\n\nexecute:\n  warning: false\n  error: false\n  eval: false\nformat:\n  html:\n    toc: true\n    toc-location: right\n    code-fold: show\n    code-tools: true\n    number-sections: true\n    code-block-bg: true\n    code-block-border-left: \"#31BAE9\"\n---\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(rvest)\nlibrary(stringr)\nlibrary(openxlsx)\nlibrary(readxl)\nlibrary(lubridate)\nlibrary(ggplot2)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\npackageVersion(\"rvest\")\n```\n:::\n\n\n\n# input\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata001=read_excel('/oputput/all_page_review.xlsx')\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nglimpse(data001)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndata002=data001%>% mutate(\n  \n  bottle_review2=bottle_review2%>% str_replace(\"–\", \"-\")%>% str_replace(\"Palate:\", \"Mouth\")\n  ,name=paste0(str_extract(bottle_review2, regex( \"[^)]+\")),\")\")\n  \n  ,colour=(bottle_review2 %>% str_match(\"Colour\\\\s*(.*?)\\\\s*\\\\.\"))[,2]\n  ,nose=(bottle_review2 %>% str_match(\"Nose:\\\\s*(.*?)\\\\s*Mouth\"))[,2]\n  ,mouth=(bottle_review2 %>% str_match(\"Mouth\\\\s*(.*?)\\\\s*Finish:\"))[,2]\n  ,finish=(bottle_review2 %>% str_match(\"Finish:\\\\s*(.*?)\\\\s*Comments:\"))[,2]\n  ,comments=(bottle_review2 %>% str_match(\"Comments:\\\\s*(.*?)\\\\s*SGP:\"))[,2]\n  \n  #,full_score=(bottle_review2 %>%str_match_all(\"[:digit:][:digit:][:space:]points.\"))%>% sapply(tail, 1)\n  ,full_score=(bottle_review2 %>%str_match_all(\"[:digit:][:digit:][:space:]points.\"))%>% sapply(tail, 1)\n  ,score=full_score %>% str_replace(\"points.\",\"\") %>% as.numeric()\n  \n  ,review_date=((str_match(old_page %>%str_to_lower(),\"https://www.whiskyfun.com/archive\\\\s*(.*?)\\\\s*-\"))[,2] )%>% str_to_title()\n  ,review_date2= myd(review_date, truncated = 1)\n  ,review_year=year(review_date2)\n)\n\nglimpse(data002)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndata002=data001 %>% mutate(\n  page_link_count=str_count(old_page,'www.whiskyfun.com'))%>%mutate(\n    page_link=ifelse(page_link_count==2,str_replace(old_page,\"https://www.whiskyfun.com/\",\"\"),old_page))%>%mutate(\n    after_page_link_count=str_count(page_link,'www.whiskyfun.com')) %>% mutate(\n      review_date=((str_match(page_link,\"https://www.whiskyfun.com/archive\\\\s*(.*?)\\\\s*-\"))[,2] )%>% str_to_title()\n      ,review_date2= myd(review_date, truncated = 1)\n      ,review_year=year(review_date2)\n      ,bottle_score=str_replace(bottle_score,'–','-')\n      ,bottle_final_score= (bottle_score%>% str_match(\"-\\\\s*(.*?)\\\\s*points\"))[,2]\n        ,score=bottle_final_score %>% str_extract(\"(\\\\d)+\")%>% as.numeric()           \n              ,review_year_flag=ifelse(review_year>=2020,'>=2020','<2020')    \n    ) %>% arrange(desc(score))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndata003=data002 %>%  filter(review_date2>='2010-01-01'\n                            ,score<=98)\n                            #,score>=70)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nglimpse(data003)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(scales)\ntest001a=data003 %>% filter(review_year>=2018) %>% group_by(score) %>% summarise(n=n()) %>% mutate(percent = (n/sum(n))) %>% arrange(desc(score)) %>% mutate(review_year_flag='>=2020')\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(scales)\ntest001b=data003 %>% filter(review_year<2018) %>% group_by(score) %>% summarise(n=n()) %>% mutate(percent = (n/sum(n))) %>% arrange(desc(score)) %>% mutate(review_year_flag='<2020')\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ntest001c=rbind(test001a,test001b) %>% filter(score>=75)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\np=ggplot(test001c, aes(score,percent,color=review_year_flag)) + geom_point()+ geom_line()\np\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(data003, aes(score,fill=review_year_flag))+geom_histogram(position = 'dodge')\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(test001b, aes(x=score,y=percent))+ geom_bar(stat=\"identity\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(data003, aes(score)) + \n  geom_histogram()\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\np=ggplot(data003, aes(review_date2, score)) + geom_point()\np\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndata004=data003 %>% mutate(above_90=ifelse(score>=90,1,0)) %>% group_by(review_year) %>% summarise(n=n()\n                                            ,avg_score=mean(score)\n                                            ,above_90=sum(above_90)\n                                            )\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\np=ggplot(data004, aes(review_year,above_90/n)) + geom_point()+ geom_line()\np\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\np=ggplot(data004, aes(review_year,avg_score)) + geom_point()+ geom_line()\np\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\np=ggplot(data004, aes(review_year,n)) + geom_point()+ geom_line()\np\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\np=ggplot(data003, aes(review_year,score,color=as.character(review_year)))  + geom_boxplot()\np\n```\n:::\n\n\n\n\n# ouput\n\n\n::: {.cell}\n\n```{.r .cell-code}\nwrite.xlsx(data003,'all_page_review_after_clean.xlsx')\n```\n:::\n\n\n\n# reference\n\n%d = Day number of month (5, 17, 28, etc.)\n\n%j = Day number of the year (Julian day 001-366)\n\n%a = Abbreviated weekday (Mon, Tue, Wed, etc.)\n\n%A = Full weekday (Monday, Tuesday, etc.) %w = Weekday number (0-6, Sunday is 0)\n\n%u = Weekday number (1-7, Monday is 1)\n\n%W = Week number (00-53, Monday is week start)\n\n%U = Week number (01-53, Sunday is week start)\n\n%m = Month number (e.g. 01, 02, 03, 04)\n\n%b = Abbreviated month (Jan, Feb, etc.)\n\n%B = Full month (January, February, etc.)\n\n%y = 2-digit year (e.g. 89)\n\n%Y = 4-digit year (e.g. 1989)\n\n%h = hours (24-hr clock)\n\n%m = minutes\n\n%s = seconds %z = offset from GMT\n\n%Z = Time zone (character)\n\n\nhttps://epirhandbook.com/en/working-with-dates.html\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}