{
  "hash": "eb5b3ae6165492152a47668dc0f4ae32",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"All page clean up\"\nsubtitle: \"with whiskyfun.com data\"\nauthor: \"Tony Duan\"\n\nexecute:\n  warning: false\n  error: false\n  eval: false\nformat:\n  html:\n    toc: true\n    toc-location: right\n    code-fold: show\n    code-tools: true\n    number-sections: true\n    code-block-bg: true\n    code-block-border-left: \"#31BAE9\"\n---\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(rvest)\nlibrary(stringr)\nlibrary(openxlsx)\nlibrary(readxl)\nlibrary(lubridate)\nlibrary(ggplot2)\n```\n:::\n\n\n\n# input\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata001=read_excel('./output/all_page_review_clean_v2.xlsx') %>% mutate(\n  title_length=nchar(name)\n  ,high_bottle=if_else(score>=90,1,0)\n  \n  )\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nglimpse(data001)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndata002=data001 %>% select(-old_page,-review_date) %>% unique() %>% filter(score>0\n                                                              ,score<=100\n                                                              ,bottle_review2 %>% str_sub(1,6)!='Colour'\n                                                               ,bottle_review2 %>% str_sub(1,4)!='Nose'\n                                                               ,bottle_review2 %>%str_sub(1,5)!='Mouth'\n                                                              ,title_length<=180\n                                                              ) %>% arrange(desc(title_length))\nglimpse(data002)\n```\n:::\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsummary001=data002 %>% group_by(review_year) %>% summarise(score=mean(score)\n                                                           ,bottles=n()\n                                                           ,high_bottle=sum(high_bottle)\n                                                           ) %>% mutate(high_bottle_per=high_bottle/bottles)\n\nsummary001\n```\n:::\n\n\n::: {.cell}\n\n```{.r .cell-code}\np=ggplot(summary001, aes(review_year,score)) + geom_point()+ geom_line()\np\n```\n:::\n\n\n::: {.cell}\n\n```{.r .cell-code}\np=ggplot(summary001, aes(review_year,bottles)) + geom_point()+ geom_line()\np\n```\n:::\n::: {.cell}\n\n```{.r .cell-code}\np=ggplot(summary001, aes(review_year,high_bottle_per)) + geom_point()+ geom_line()\np\n```\n:::\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(plotly)\npp=plot_ly(summary001, x = ~review_year, y = ~bottles, type = \"bar\", name = \"bottles\") %>%\n  add_trace(x = ~review_year, y = ~score, type = 'scatter', mode = \"lines\", yaxis = \"y2\", name = \"score\", line = list(color = 'rgb(205, 12, 24)', width = 8)) %>%\n  \n  layout(\n    title = 'Whiksyfun review bottles and average score'\n    ,legend = list(orientation = 'h')\n     ,xaxis = list(range=c(2003,2025))\n    ,yaxis2 = list(overlaying = \"y\", side = \"right\",range=c(80,90))\n    ,yaxis = list(range=c(0,1500))\n         )\n\npp\n```\n:::\n\n\n::: {.cell}\n\n```{.r .cell-code}\norca(pp, \"plot.png\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(plotly)\npp=plot_ly(summary001, x = ~review_year, y = ~bottles, type = \"bar\", name = \"瓶\",text=~bottles) %>%\n  add_trace(x = ~review_year, y = ~score, type = 'scatter', mode = \"lines\", yaxis = \"y2\", name = \"平均分\", line = list(color = 'rgb(205, 12, 24)', width = 8)) %>%\n  \n  layout(\n    title = 'WF每年酒评数量和平均分'\n    ,showlegend = FALSE\n     ,xaxis = list(title='年'\n                   ,dtick = 2\n                   ,tick0 = 2004\n      ,tickmode = \"linear\"\n      )\n    ,margin=list(\n  l = 50,\n  r = 50,\n  b = 100,\n  t = 100,\n  pad = 4\n)\n    ,yaxis2 = list(overlaying = \"y\", side = \"left\",range=c(80,90),title='平均分')\n    ,yaxis = list(side=\"left\",zeroline = FALSE,showline = FALSE,showticklabels = FALSE,showgrid = FALSE,title='')\n    ,annotations = list(x = 1, y = -0.2, \n                              text = \"2004-09 to 2024-05\", \n                              showarrow = F, \n                              xref='paper', \n                              yref='paper'\n      )\n                              \n       ,images = list(  \n      list(  \n        source = base64enc::dataURI(file = \"wf logo.png\")\n        ,xref = \"paper\"\n        ,yref = \"paper\" \n        ,x = 0.01\n        ,y = -0.08\n        ,sizex = 0.4\n        ,sizey = 0.4\n       ,xanchor=\"left\"  \n      )  \n    )   )\n\npp\n```\n:::\n\n\n::: {.cell}\n\n```{.r .cell-code}\norca(pp, \"plot2.png\")\n```\n:::",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}