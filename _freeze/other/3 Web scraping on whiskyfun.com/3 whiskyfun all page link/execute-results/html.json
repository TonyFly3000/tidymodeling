{
  "hash": "8c99053104387bcf62480a8eb6026762",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"All page link frist time\"\nsubtitle: \"with whiskyfun.com data\"\nauthor: \"Tony Duan\"\n\nexecute:\n  warning: false\n  error: false\n  eval: false\nformat:\n  html:\n    toc: true\n    toc-location: right\n    code-fold: show\n    code-tools: true\n    number-sections: true\n    code-block-bg: true\n    code-block-border-left: \"#31BAE9\"\n---\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(rvest)\nlibrary(curl)\nlibrary(stringr)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\npackageVersion(\"rvest\")\n```\n:::\n\n\n# all review page\n\n# first page\n::: {.cell}\n\n```{.r .cell-code}\nfirst_url='https://www.whiskyfun.com'\nfirst_page=read_html(first_url)\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlast_page <- first_page %>%\n  html_elements(css = \"a.textegrandfoncegras\")%>% html_attr(\"href\")\n\nlast_page\n```\n:::\n\n\n# start to download 500 pages\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#last_page='https://www.whiskyfun.com/archivemarch24-2-Port-Ellen-Glen-Grant.html'\nlast_page='https://www.whiskyfun.com'\nlast_page=\"https://www.whiskyfun.com/ArchiveOctober04-2.html\"\npage_list=c()\na=0\n  \nfor (i in seq(1:500)){\n  print(i)\n  ###################### each page max try 10 times \n  tryCatch({\n    #page=read_html(last_page)\n    page=read_html(curl(last_page, handle = curl::new_handle(\"useragent\" = \"Mozilla/5.0\")))\n    i=i+1\n    \n  Sys.sleep(runif(n=1, min=0.1, max=0.3))\n },error = function(msg){print('eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee')\n    i=i-1\n    print(paste0(\"new i : \",i))\n    a=a+1\n    })\n   if(a>10){break}\n  \n  ##############################################\n  #if (last_page %>% is.na()==TRUE){break}\n\n  ### first page\n   if(last_page=='https://www.whiskyfun.com'){\n    last_page <- (page %>%html_elements(css = \"a.textegrandfoncegras\")%>%html_attr(\"href\"))[1]\n    \n  #### all other     \n    }else {\n  last_page <- (page %>%html_elements(css = \"font:nth-child(1) strong a\")%>%html_attr(\"href\"))[1]\n   ###  before 2004 oct\n  if(last_page %>% is.na()==TRUE){\n    last_page <- (page %>%html_elements(css = \"font:nth-child(1) b a\")%>%html_attr(\"href\"))[1]\n  }\n    }\n  \n  if(last_page%>% str_sub(1,26)=='https://www.whiskyfun.com/'){\n    last_page=last_page}else{\n  last_page=paste0('https://www.whiskyfun.com/',last_page)\n    }\n  \n  print(last_page)\n  if (last_page %in% page_list|last_page==\"https://www.whiskyfun.com/http://www.lambchop.net/\"){break}\n  page_list=c(page_list,last_page)\n  Sys.sleep(runif(n=1, min=0.1, max=0.8))\n  \n  \n  }\n```\n:::\n\n# add first page\n\n::: {.cell}\n\n```{.r .cell-code}\npage_list_data=page_list %>% tibble()\n```\n:::\n\n\n# ouput\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(openxlsx)\nwrite.xlsx(page_list_data, file = \"./output/wf_all_page_review_v2.xlsx\")\n```\n:::\n\n\n\n\n\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}