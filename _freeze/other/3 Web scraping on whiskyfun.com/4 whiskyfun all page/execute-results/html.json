{
  "hash": "72553590008de66df5c1d9a4afc5e823",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"All page second time\"\nsubtitle: \"with whiskyfun.com data\"\nauthor: \"Tony Duan\"\n\nexecute:\n  warning: false\n  error: false\n  eval: false\nformat:\n  html:\n    toc: true\n    toc-location: right\n    code-fold: show\n    code-tools: true\n    number-sections: true\n    code-block-bg: true\n    code-block-border-left: \"#31BAE9\"\n---\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(rvest)\nlibrary(curl)\nlibrary(stringr)\nlibrary(openxlsx)\nlibrary(readxl)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\npackageVersion(\"rvest\")\n```\n:::\n\n\n# all review page\n\n# first page\n::: {.cell}\n\n```{.r .cell-code}\nfirst_url='https://www.whiskyfun.com'\nfirst_page=read_html(first_url)\n```\n:::\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlast_page <- first_page %>%\n  html_elements(css = \"a.textegrandfoncegras\")%>% html_attr(\"href\")\n```\n:::\n\n\n# start from secound page\n\n\n::: {.cell}\n\n```{.r .cell-code}\npage_list=c()\n```\n:::\n\n\n::: {.cell}\n\n```{.r .cell-code}\nurl='https://www.whiskyfun.com/archivemarch24-2-Port-Ellen-Glen-Grant.html'\n\npage=read_html(first_url)\n\nlast_page <- (first_page %>%html_elements(css = \"font:nth-child(1) strong a\")%>%html_attr(\"href\"))[1]\n\nprint(last_page)\npage_list=c(page_list,last_page)\n```\n:::\n\n\n\n# start to download 500 pages\n::: {.cell}\n\n```{.r .cell-code}\nlast_page='https://www.whiskyfun.com/'\n\npage_list=c()\ndata_list=tibble()\n\ni=0\na=0\n\nwhile (i < 500) {\n  loop_num=i\n  print(paste0(\"current page: \",loop_num))\n\n  tryCatch({\n    #page=read_html(last_page)\n    old_page=last_page\n    page=read_html(curl(last_page, handle = curl::new_handle(\"useragent\" = \"Mozilla/5.0\")))\n    i=i+1\n    \n  Sys.sleep(runif(n=1, min=0.1, max=0.3))\n },error = function(msg){print('eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee')\n    i=i-1\n    print(paste0(\"new i : \",i))\n    a=a+1\n    })\n   if(a>10){break}\n  \n\n##############################################\n  #if (last_page %>% is.na()==TRUE){break}\n\n  ### first page\n   if(last_page=='https://www.whiskyfun.com/'){\n    last_page <- (page %>%html_elements(css = \"a.textegrandfoncegras\")%>%html_attr(\"href\"))[1]\n    \n  #### all other     \n    }else {\n  last_page <- (page %>%html_elements(css = \"font:nth-child(1) strong a\")%>%html_attr(\"href\"))[1]\n   ###  before 2004 oct\n  if(last_page %>% is.na()==TRUE){\n    last_page <- (page %>%html_elements(css = \"font:nth-child(1) b a\")%>%html_attr(\"href\"))[1]\n  }\n    }\n  \n  if(last_page%>% str_sub(1,26)=='https://www.whiskyfun.com/'){\n    last_page=last_page}else{\n  last_page=paste0('https://www.whiskyfun.com/',last_page)\n    }\n  \n  print(last_page)\n  #if (last_page %in% page_list|last_page==\"https://www.whiskyfun.com/http://www.lambchop.net/\"){break}\n  page_list=c(page_list,last_page)\n  Sys.sleep(runif(n=1, min=0.1, max=0.8))\n  \n  \n  #######################\n  review_html_elements=\".textegrandfoncegras , .TextenormalNEW, .Textenormal,td > font,div td font\"\n  bottle_review=page  %>% html_elements(review_html_elements) %>% html_text2()\n# remove space element\n\n  bottle_review1=bottle_review[bottle_review %>% str_detect(' points')]\n\n  bottle_review2=bottle_review1[bottle_review1 %>% str_detect('Nose:')]\n\n  bottle_review2=bottle_review2%>% str_replace(\"Palate:\", \"Mouth\")%>% str_replace(\"–\", \"-\")\n\n  bottle_name=str_extract(bottle_review2, regex( \"[^)]+\"))\n  bottle_name=paste0(bottle_name,\")\")\n  print(head(bottle_name,2))\n  print(paste0(\"this page have bottle: \",length(bottle_name)))\n  \n\n  ##### break the loop if can not download continue >=3 pages\n  if (length(bottle_name)==1){fail_num=fail_num+1}else{fail_num=0}\n    \n  if (fail_num>=3){\n    print(paste0(\"breaking page url: \",old_page))\n    break\n    }\n  ################################################################\n  \n  # res <- str_match(bottle_review2, \" \\\\s*(.*?)\\\\s*points\")\n  # bottle_score=paste(\"SGP:\",res[,2],\" points\")%>% str_replace(\"–\", \"-\")\n  # \n  # res <- str_match(bottle_score, \" - \\\\s*(.*?)\\\\s*points\")\n  # bottle_final_score=res[,2]\n  # \n  # res <- str_match(bottle_review2, \"Nose:\\\\s*(.*?)\\\\s*Mouth\")\n  # bottle_name_nose=paste(\"Nose:\",res[,2])\n  # \n  # res <- str_match(bottle_review2, \"Mouth\\\\s*(.*?)\\\\s*Finish:\")\n  # bottle_name_mouth=paste(\"Mouth:\",res[,2])\n  # \n  # res <- str_match(bottle_review2, \"Colour\\\\s*(.*?)\\\\s*\\\\.\")\n  # bottle_name_colour=paste(\"Colour \",res[,2])\n  # \n  # res <- str_match(bottle_review2, \"Finish:\\\\s*(.*?)\\\\s*Comments:\")\n  # bottle_name_finish=paste(\"Finish:\",res[,2])\n  # \n  # res <- str_match(bottle_review2, \"Comments:\\\\s*(.*?)\\\\s*SGP:\")\n  # bottle_name_comments=paste(\"Comments:\",res[,2])\n  # \n  # data=tibble(bottle_review2,bottle_name,bottle_name_nose,bottle_name_mouth,bottle_name_finish,bottle_name_colour,bottle_name_comments,bottle_score,bottle_final_score,old_page,loop_num) %>% unique()\n  # \n  # data_list=rbind(data_list,data)\n  # print(paste0(\"total bootle downlaoded: \",nrow(data_list)))\n  data=tibble(bottle_review2,bottle_name,old_page,loop_num) %>% unique()\n  data_list=rbind(data_list,data)\n  print(paste0(\"total bootle downlaoded: \",nrow(data_list)))\n  \n\n  ####### ouput every 10 page\n  if (i%%10==0){\n\n      print(paste0(\"output to excel: \", i))\n      write.xlsx(data_list,'all_page_review_all_v2.xlsx')\n     }\n  \n  Sys.sleep(runif(n=1, min=0.1, max=0.3))\n}\n\ndata_list=data_list %>% select(-loop_num)%>% unique()\nwrite.xlsx(data_list,'./output/all_page_review_all_v2.xlsx')\n```\n:::\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n# whiskyfun first page\nhttps://www.whiskyfun.com/ArchiveJan04.html\n\n# whiskyfun last muic page\nhttps://www.whiskyfun.com/archivejanuary18-1-Linkwood-Ardmore-Clynelish.html\n\n\n\n\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}